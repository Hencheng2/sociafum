{% extends 'base.html' %}

{% block title %}Edit My Details{% endblock %}

{% block content %}
<style>
    /* Custom styles for Edit My Details page */
    body {
        padding-top: 0;
        padding-bottom: var(--navbar-height); /* Space for fixed bottom navbar */
        overflow-x: hidden;
    }

    .edit-profile-container {
        max-width: 700px;
        margin: 20px auto;
        padding: 20px 15px;
        background-color: var(--background-light);
    }

    .edit-profile-card {
        background-color: var(--card-background);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow-medium);
        padding: 25px;
    }

    .edit-profile-card h2 {
        text-align: center;
        color: var(--primary-text);
        margin-bottom: 30px;
        font-weight: 700;
    }

    .profile-photo-upload-wrapper {
        text-align: center;
        margin-bottom: 30px;
    }

    .profile-photo-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        margin-bottom: 15px;
        display: block; /* Center image */
        margin-left: auto;
        margin-right: auto;
    }

    .btn-upload-photo {
        background-color: var(--button-bg-secondary);
        color: var(--button-text-secondary);
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 0.95em;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .btn-upload-photo:hover {
        background-color: darken(var(--button-bg-secondary), 5%);
        transform: translateY(-1px);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 600;
        color: var(--primary-text);
        margin-bottom: 8px;
    }

    .form-control, .form-select {
        border-radius: 8px;
        padding: 10px 15px;
        background-color: var(--background-light);
        color: var(--primary-text);
        border: 1px solid var(--input-border-color);
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(88, 129, 87, 0.25);
    }

    .input-group-text {
        background-color: var(--button-bg-secondary);
        color: var(--button-text-secondary);
        border: 1px solid var(--input-border-color);
        border-right: none;
        border-radius: 8px 0 0 8px;
    }
    .input-group .form-control:first-child {
        border-left: none; /* remove redundant border */
    }

    .btn-submit {
        background-color: var(--primary-color);
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        font-size: 1.1em;
        font-weight: 600;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .btn-submit:hover {
        background-color: darken(var(--primary-color), 10%);
        transform: translateY(-2px);
    }

    .btn-cancel {
        background-color: var(--secondary-color);
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        font-size: 1.1em;
        font-weight: 600;
    }
    .btn-cancel:hover {
        background-color: darken(var(--secondary-color), 10%);
        transform: translateY(-2px);
    }


    /* Responsive adjustments */
    @media (max-width: 768px) {
        .edit-profile-container {
            margin: 15px auto;
            padding: 15px 10px;
        }
        .edit-profile-card {
            padding: 20px;
        }
        .edit-profile-card h2 {
            font-size: 1.8em;
            margin-bottom: 25px;
        }
        .profile-photo-preview {
            width: 100px;
            height: 100px;
        }
        .btn-upload-photo {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn-submit, .btn-cancel {
            padding: 10px 20px;
            font-size: 1em;
        }
    }

    @media (max-width: 480px) {
        .edit-profile-card {
            padding: 15px;
        }
        .profile-photo-preview {
            width: 90px;
            height: 90px;
        }
        .btn-upload-photo {
            font-size: 0.8em;
        }
        .form-label {
            font-size: 0.9em;
        }
        .form-control, .form-select {
            padding: 8px 12px;
            font-size: 0.9em;
        }
        .btn-submit, .btn-cancel {
            font-size: 0.95em;
        }
    }
</style>

<div class="edit-profile-container">
    <div class="edit-profile-card">
        <h2>Edit Your Profile</h2>

        <form action="{{ url_for('edit_my_details') }}" method="POST" enctype="multipart/form-data">
            {# Profile Photo Upload #}
            <div class="profile-photo-upload-wrapper">
                <img id="profilePhotoPreview" src="{{ current_user_profile.profile_pic }}" alt="Profile Photo Preview" class="profile-photo-preview">
                <label for="profilePhotoFile" class="btn btn-upload-photo">
                    <i class="fas fa-camera me-2"></i> Change Photo
                </label>
                <input type="file" class="form-control-file" id="profilePhotoFile" name="profilePhotoFile" style="display:none;" accept="image/*">
            </div>

            {# Username #}
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                {# Username is read-only, its value comes from current_user.username #}
                <input type="text" class="form-control" id="username" name="username_display" value="{{ current_user.username }}" required readonly title="Username cannot be changed directly here.">
                <small class="form-text text-muted">Username is unique and currently cannot be changed directly.</small>
            </div>

            {# Full Name - Added for consistency with members.fullName in app.py #}
            <div class="form-group">
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="fullName" name="fullName" value="{{ current_user_profile.real_name }}" placeholder="Your full name" required>
            </div>

            {# Biography #}
            <div class="form-group">
                <label for="bio" class="form-label">Biography</label>
                <textarea class="form-control" id="bio" name="bio" rows="4" placeholder="Tell us about yourself...">{{ current_user_profile.bio }}</textarea>
                <small class="form-text text-muted">You can tag other users using @username in your biography.</small>
            </div>

            <hr class="my-4">

            <h3>Basic Info</h3>
            {# Date of Birth #}
            <div class="form-group">
                <label for="dateOfBirth" class="form-label">Date of Birth</label>
                <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth" value="{{ current_user_profile.dob }}">
            </div>

            {# Gender #}
            <div class="form-group">
                <label for="gender" class="form-label">Gender</label>
                <select class="form-select" id="gender" name="gender">
                    <option value="">Select Gender</option>
                    <option value="Male" {% if current_user_profile.gender == 'Male' %}selected{% endif %}>Male</option>
                    <option value="Female" {% if current_user_profile.gender == 'Female' %}selected{% endif %}>Female</option>
                    <option value="Non-binary" {% if current_user_profile.gender == 'Non-binary' %}selected{% endif %}>Non-binary</option>
                    <option value="Prefer not to say" {% if current_user_profile.gender == 'Prefer not to say' %}selected{% endif %}>Prefer not to say</option>
                </select>
            </div>

            {# Pronouns #}
            <div class="form-group">
                <label for="pronouns" class="form-label">Pronouns</label>
                <select class="form-select" id="pronouns" name="pronouns">
                    <option value="">Select Pronouns</option>
                    <option value="He/Him" {% if current_user_profile.pronouns == 'He/Him' %}selected{% endif %}>He/Him</option>
                    <option value="She/Her" {% if current_user_profile.pronouns == 'She/Her' %}selected{% endif %}>She/Her</option>
                    <option value="They/Them" {% if current_user_profile.pronouns == 'They/Them' %}selected{% endif %}>They/Them</option>
                    <option value="Ze/Zir" {% if current_user_profile.pronouns == 'Ze/Zir' %}selected{% endif %}>Ze/Zir</option>
                    <option value="Other" {% if current_user_profile.pronouns == 'Other' %}selected{% endif %}>Other</option>
                </select>
            </div>

            <hr class="my-4">

            <h3>Work & Education</h3>
            {# Work Info #}
            <div class="form-group">
                <label for="workInfo" class="form-label">Work Information</label>
                <input type="text" class="form-control" id="workInfo" name="workInfo" value="{{ current_user_profile.work_info }}" placeholder="e.g., Software Engineer at Google">
            </div>

            {# University #}
            <div class="form-group">
                <label for="university" class="form-label">University</label>
                <input type="text" class="form-control" id="university" name="university" value="{{ current_user_profile.university }}" placeholder="e.g., Harvard University">
            </div>

            {# Secondary School #}
            <div class="form-group">
                <label for="secondary" class="form-label">Secondary School</label>
                <input type="text" class="form-control" id="secondary" name="secondary" value="{{ current_user_profile.secondary }}" placeholder="e.g., St. Mary's High School">
            </div>

            <hr class="my-4">

            <h3>Places Lived</h3>
            {# Location #}
            <div class="form-group">
                <label for="location" class="form-label">Current City</label>
                <input type="text" class="form-control" id="location" name="location" value="{{ current_user_profile.location }}" placeholder="e.g., Nairobi, Kenya">
            </div>

            <hr class="my-4">

            <h3>Contact Information</h3>
            {# Phone Number #}
            <div class="form-group">
                <label for="contact" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="contact" name="contact" value="{{ current_user_profile.phone }}" placeholder="e.g., +254712345678">
            </div>

            {# Email #}
            <div class="form-group">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" value="{{ current_user_profile.email }}" placeholder="e.g., your.email@example.com">
            </div>

            {# Social Link #}
            <div class="form-group">
                <label for="socialLink" class="form-label">Social Media Link</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-link"></i></span>
                    <input type="url" class="form-control" id="socialLink" name="socialLink" value="{{ current_user_profile.social_link }}" placeholder="e.g., https://instagram.com/yourprofile">
                </div>
            </div>

            {# Website Link #}
            <div class="form-group">
                <label for="websiteLink" class="form-label">Personal Website Link</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-globe"></i></span>
                    <input type="url" class="form-control" id="websiteLink" name="websiteLink" value="{{ current_user_profile.website_link }}" placeholder="e.g., https://yourwebsite.com">
                </div>
            </div>

            <hr class="my-4">

            <h3>Relationship</h3>
            {# Relationship Status #}
            <div class="form-group">
                <label for="maritalStatus" class="form-label">Relationship Status</label>
                <select class="form-select" id="maritalStatus" name="maritalStatus">
                    <option value="">Select Status</option>
                    <option value="Single" {% if current_user_profile.relationship_status == 'Single' %}selected{% endif %}>Single</option>
                    <option value="In a relationship" {% if current_user_profile.relationship_status == 'In a relationship' %}selected{% endif %}>In a relationship</option>
                    <option value="Engaged" {% if current_user_profile.relationship_status == 'Engaged' %}selected{% endif %}>Engaged</option>
                    <option value="Married" {% if current_user_profile.relationship_status == 'Married' %}selected{% endif %}>Married</option>
                    <option value="Divorced" {% if current_user_profile.relationship_status == 'Divorced' %}selected{% endif %}>Divorced</option>
                    <option value="Widowed" {% if current_user_profile.relationship_status == 'Widowed' %}selected{% endif %}>Widowed</option>
                    <option value="It's complicated" {% if current_user_profile.relationship_status == 'It\'s complicated' %}selected{% endif %}>It's complicated</option>
                </select>
            </div>

            {# Spouse/Fiancee Name (Conditional) #}
            <div class="form-group" id="spouseFianceeField" style="display:none;">
                <label for="spouseNames" class="form-label" id="spouseFianceeLabel">Spouse/Fiancée's Name</label>
                <input type="text" class="form-control" id="spouseNames" name="spouseNames" value="{{ current_user_profile.spouse_fiancee_name }}" placeholder="Tag your partner using @username">
                <small class="form-text text-muted">You can tag your partner using their @username.</small>
            </div>
            
            {# Personal Relationship Description #}
            <div class="form-group">
                <label for="personalRelationshipDescription" class="form-label">Personal Relationship Description</label>
                <textarea class="form-control" id="personalRelationshipDescription" name="personalRelationshipDescription" rows="3" placeholder="Describe your relationship...">{{ current_user_profile.personal_relationship_description }}</textarea>
                <small class="form-text text-muted">Describe your relationship status in more detail.</small>
            </div>


            <div class="d-grid gap-2 mt-5">
                <button type="submit" class="btn btn-primary btn-submit">Save Changes</button>
                <a href="{{ url_for('my_profile') }}" class="btn btn-secondary btn-cancel">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Profile Photo Preview ---
        const profilePhotoFile = document.getElementById('profilePhotoFile');
        const profilePhotoPreview = document.getElementById('profilePhotoPreview');

        if (profilePhotoFile && profilePhotoPreview) {
            profilePhotoFile.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePhotoPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Fallback to current photo if no file selected
                    profilePhotoPreview.src = "{{ current_user_profile.profile_pic }}";
                }
            });
        }

        // --- Conditional Spouse/Fiancee Field ---
        const relationshipStatusSelect = document.getElementById('maritalStatus'); // Changed ID to match name
        const spouseFianceeField = document.getElementById('spouseFianceeField');
        const spouseFianceeLabel = document.getElementById('spouseFianceeLabel');
        const spouseFianceeInput = document.getElementById('spouseNames'); // Changed ID to match name

        function toggleSpouseFianceeField() {
            const selectedStatus = relationshipStatusSelect.value;
            if (selectedStatus === 'Engaged' || selectedStatus === 'Married') {
                spouseFianceeField.style.display = 'block';
                spouseFianceeLabel.textContent = selectedStatus === 'Engaged' ? "Fiancée's Name" : "Spouse's Name";
                // If it's "Dating", show a different input or just default to partner's name
                // Your app.py also checks for 'girlfriendNames' for 'Dating' status, you might want to adjust this.
            } else {
                spouseFianceeField.style.display = 'none';
                spouseFianceeInput.value = ''; // Clear value when hidden
            }
        }

        relationshipStatusSelect.addEventListener('change', toggleSpouseFianceeField);
        // Initial call to set visibility based on current value
        toggleSpouseFianceeField();
    });
</script>
{% endblock %}
