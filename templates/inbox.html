{% extends 'base.html' %}

{% block title %}Inbox{% endblock %}

{% block content %}
<style>
    .navbar {
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 10px 0;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .navbar a {
        text-decoration: none;
        color: #333;
        padding: 8px 16px;
        font-weight: 500;
        cursor: pointer;
    }
    .navbar a:hover, .navbar a.active {
        background-color: #e9ecef;
        border-radius: 4px;
    }
    .search-bar {
        padding: 10px;
        margin-bottom: 10px;
    }
    .search-bar input {
        width: 100%;
        padding: 8px;
        font-size: 16px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    .tab-content {
        display: none;
        padding: 20px;
    }
    .tab-content.active {
        display: block;
    }
    .chat-item, .group-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }
    .chat-item img, .group-item img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .chat-info, .group-info {
        flex: 1;
    }
    .chat-info h3, .group-info h3 {
        margin: 0;
        font-size: 16px;
    }
    .chat-info p, .group-info p {
        margin: 0;
        font-size: 12px;
        color: #666;
    }
    .chat-time {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    .chat-time small {
        font-size: 12px;
        color: #999;
    }
    .unread-count {
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        margin-top: 5px;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .conversation-navbar {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .conversation-navbar img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .conversation-navbar h3 {
        margin: 0;
        flex: 1;
    }
    .dropdown {
        position: relative;
        display: inline-block;
    }
    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
    }
    .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }
    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }
    .dropdown:hover .dropdown-content {
        display: block;
    }
    .message-area {
        position: fixed;
        bottom: 0;
        width: 100%;
        padding: 10px;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
    }
    .message-area input {
        flex: 1;
        padding: 8px;
        margin-right: 10px;
    }
    .message-area button {
        margin-left: 5px;
    }
</style>

<div class="search-bar">
    <input type="text" placeholder="Search..." id="searchInput" oninput="searchInbox()">
</div>

<div class="navbar">
    <a onclick="showTab('chats')" id="chats-tab">Chats {% if unread_chats_count %} ({{ unread_chats_count }}) {% endif %}</a>
    <a onclick="showTab('groups')" id="groups-tab">Groups {% if unread_groups_count %} ({{ unread_groups_count }}) {% endif %}</a>
    <a onclick="showTab('new')" id="new-tab">New</a>
</div>

<div id="chats" class="tab-content">
    {% if chats %}
        {% for chat in chats %}
        <div class="chat-item" onclick="openConversation('chat', {{ chat.other_user.id }})" data-name="{{ chat.other_user.real_name }}" data-username="{{ chat.other_user.username | default('') }}">
            <img src="{{ chat.other_user.profile_photo | default('/static/img/default_profile.png') }}" alt="Profile">
            <div class="chat-info">
                <h3>{{ chat.other_user.real_name }}</h3>
                <p>{{ chat.latest_message_snippet }}</p>
            </div>
            <div class="chat-time">
                <small>{{ moment(chat.timestamp).fromNow() }}</small>
                {% if chat.unread_count > 0 %}
                <span class="unread-count">{{ chat.unread_count }}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div>
            <p>No direct messages yet.</p>
            <p>Start a conversation with a friend!</p>
        </div>
    {% endif %}
</div>

<div id="groups" class="tab-content">
    {% if groups %}
        {% for group in groups %}
        <div class="group-item" onclick="openConversation('group', {{ group.id }})" data-name="{{ group.name }}">
            <img src="{{ group.profile_photo | default('/static/img/default_group.png') }}" alt="Group Profile">
            <div class="group-info">
                <h3>{{ group.name }}</h3>
                <p>{{ group.latest_message_snippet }}</p>
            </div>
            <div class="chat-time">
                <small>{{ moment(group.timestamp).fromNow() }}</small>
                {% if group.unread_count > 0 %}
                <span class="unread-count">{{ group.unread_count }}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div>
            <p>No group chats yet.</p>
            <p>Create a new group or join an existing one!</p>
        </div>
    {% endif %}
</div>

<div id="new" class="tab-content">
    <h2>Create New Group</h2>
    <form method="POST" action="{{ url_for('create_group') }}" enctype="multipart/form-data">
        <div>
            <label for="group_photo">Upload Photo</label>
            <input type="file" id="group_photo" name="group_photo">
        </div>
        <div>
            <label for="group_name">Group Name</label>
            <input type="text" id="group_name" name="group_name" required>
        </div>
        <!-- Add other group info fields as needed -->
        <button type="submit">Create Group</button>
        <button type="button" onclick="cancelCreate()">Cancel</button>
    </form>
</div>

<!-- Modal for Conversation -->
<div id="conversationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="conversationNavbar" class="conversation-navbar">
            <button onclick="closeModal()">&larr;</button>
            <img id="convProfilePic" src="" alt="Profile">
            <h3 id="convName"></h3>
            <small id="convUsername"></small>
            <div class="dropdown">
                <button>&#8942;</button>
                <div class="dropdown-content" id="dropdownOptions">
                    <!-- Options will be populated based on type -->
                </div>
            </div>
        </div>
        <div id="conversationBody">
            <!-- Messages would load here via AJAX or similar -->
            <p>Conversation content loads here...</p>
        </div>
        <div class="message-area">
            <button><i class="fa fa-smile-o"></i></button> <!-- Stickers -->
            <button><i class="fa fa-paperclip"></i></button> <!-- Attach -->
            <button><i class="fa fa-camera"></i></button> <!-- Camera -->
            <button><i class="fa fa-microphone"></i></button> <!-- Microphone -->
            <input type="text" placeholder="Type a message...">
            <button><i class="fa fa-paper-plane"></i></button> <!-- Send -->
        </div>
    </div>
</div>

<script>
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.navbar a').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        document.getElementById(tabId + '-tab').classList.add('active');
    }

    function searchInbox() {
        let searchTerm = document.getElementById('searchInput').value.toLowerCase();
        let activeTab = document.querySelector('.tab-content.active');
        if (!activeTab) return;

        let items = activeTab.querySelectorAll('.chat-item, .group-item');
        items.forEach(item => {
            let name = item.dataset.name.toLowerCase();
            let username = item.dataset.username ? item.dataset.username.toLowerCase() : '';
            if (name.startsWith(searchTerm) || username.startsWith(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function openConversation(type, id) {
        let modal = document.getElementById('conversationModal');
        modal.style.display = 'block';

        // Populate navbar based on type (chat or group)
        // This is placeholder; in real, fetch data via AJAX
        let name = type === 'chat' ? 'User Name' : 'Group Name';
        let username = type === 'chat' ? '@username' : '';
        let profilePic = '/static/img/default_profile.png'; // or group

        document.getElementById('convProfilePic').src = profilePic;
        document.getElementById('convName').innerText = name;
        document.getElementById('convUsername').innerText = username;

        let dropdown = document.getElementById('dropdownOptions');
        dropdown.innerHTML = '';
        if (type === 'chat') {
            ['Customize name', 'Change chat wallpaper', 'Search', 'View user', 'Disappearing message', 'Block', 'Report'].forEach(opt => {
                let a = document.createElement('a');
                a.innerText = opt;
                dropdown.appendChild(a);
            });
        } else if (type === 'group') {
            ['Change chat wallpaper', 'Search', 'View group', 'Disappearing message', 'Leave', 'Report'].forEach(opt => {
                let a = document.createElement('a');
                a.innerText = opt;
                dropdown.appendChild(a);
            });
        }

        // Load conversation body (placeholder)
    }

    function closeModal() {
        document.getElementById('conversationModal').style.display = 'none';
    }

    function cancelCreate() {
        showTab('chats'); // Or hide, but since tab, switch back
    }

    // Show Chats tab by default
    showTab('chats');
</script>

{% endblock %}
