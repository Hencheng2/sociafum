{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<style>
    .header-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .whats-on-mind {
        flex: 1;
        display: flex;
        align-items: center;
        cursor: pointer;
        margin-right: 10px;
    }
    .whats-on-mind img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .whats-on-mind input {
        flex: 1;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        background-color: #e9ecef;
    }
    .search-bar {
        flex: 1;
        margin-left: 10px;
    }
    .search-bar form {
        display: flex;
    }
    .search-bar input {
        flex: 1;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
    }
    .search-bar button {
        padding: 8px 16px;
        margin-left: 5px;
        border: none;
        background: #007bff;
        color: white;
        border-radius: 20px;
        cursor: pointer;
    }
    .tab-container {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 10px;
    }
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: bold;
        color: #6c757d;
    }
    .tab.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .stories-container {
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
    }
    .story-item {
        text-align: center;
        margin: 0 10px;
        cursor: pointer;
    }
    .story-item img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 2px solid #007bff;
    }
    .story-item p {
        margin: 5px 0 0;
        font-size: 12px;
    }
    .add-story {
        position: relative;
    }
    .add-story::after {
        content: '+';
        position: absolute;
        bottom: 0;
        right: 0;
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
    .post {
        border: 1px solid #dee2e6;
        margin: 10px 0;
        padding: 10px;
        background-color: white;
    }
    .post-header {
        display: flex;
        align-items: center;
    }
    .post-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .post-header div {
        flex: 1;
    }
    .post-header h3 {
        margin: 0;
        font-size: 16px;
    }
    .post-header small {
        font-size: 12px;
        color: #999;
    }
    .post-content p {
        margin: 10px 0;
    }
    .post-actions {
        display: flex;
        justify-content: space-between;
    }
    .post-actions button {
        background: none;
        border: none;
        cursor: pointer;
    }
    .loader {
        text-align: center;
        padding: 20px;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: black;
    }
    .modal-content {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content img, .modal-content video, .modal-content audio {
        max-width: 100%;
        max-height: 100%;
    }
    .progress-bar {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        height: 3px;
        background-color: rgba(255,255,255,0.3);
    }
    .progress {
        height: 100%;
        background-color: white;
        width: 0;
    }
</style>

{% if current_user.is_authenticated %}
    <div class="header-container">
        <div class="whats-on-mind" onclick="window.location.href='{{ url_for('create_post') }}'">
            <img src="{{ current_user.get_member_profile().profilePhoto | default('/static/img/default_profile.png') }}" alt="Profile">
            <input type="text" placeholder="What's on your mind?" readonly>
        </div>
        <div class="search-bar">
            <form action="{{ url_for('search') }}" method="GET">
                <input type="text" name="q" placeholder="Search SociaFam">
                <button type="submit">Search</button>
            </form>
        </div>
    </div>

    <div class="tab-container">
        <div class="tab active" onclick="showTab('home')">Home</div>
        <div class="tab" onclick="window.location.href='{{ url_for('search') }}'">Search</div>
    </div>

    <div id="home" class="tab-content active">
        <div class="stories-container">
            <div class="story-item add-story" onclick="addStory()">
                <img src="{{ current_user.get_member_profile().profilePhoto | default('/static/img/default_profile.png') }}" alt="Your Story">
                <p>Your Story</p>
            </div>
            {% for story in stories %}
            <div class="story-item" onclick="openStoryModal({{ loop.index0 }})" data-id="{{ story.id }}" data-type="{{ story.media_type }}" data-path="{{ story.media_path }}" data-username="{{ story.username }}">
                <img src="{{ story.media_path if story.media_type == 'image' else '/static/img/default_story.png' }}" alt="Story">
                <p>{{ story.username }}</p>
            </div>
            {% endfor %}
        </div>

        <div id="posts-container">
            {% for post in posts %}
            <div class="post">
                <div class="post-header">
                    <img src="{{ post.user_profile_photo | default('/static/img/default_profile.png') }}" alt="Profile">
                    <div>
                        <h3>{{ post.user_real_name }} <small>@{{ post.username }}</small></h3>
                        <small>{{ moment(post.timestamp).fromNow() }}</small>
                    </div>
                </div>
                <div class="post-content">
                    <p>{{ post.description }}</p>
                    {% if post.media_path %}
                    {% if post.media_type == 'image' %}
                    <img src="{{ post.media_path }}" alt="Post Media" style="width:100%;">
                    {% elif post.media_type == 'video' %}
                    <video src="{{ post.media_path }}" controls style="width:100%;"></video>
                    {% endif %}
                    {% endif %}
                </div>
                <div class="post-actions">
                    <button>Like ({{ post.likes_count }})</button>
                    <button>Comment ({{ post.comments_count }})</button>
                    <button>Share</button>
                    <button>Follow</button>
                    <button>Save</button>
                    <button>Repost</button>
                    <button>Report</button>
                    <button>Hide</button>
                    <button>Notifications for this type</button>
                    <button>Block {{ post.username }}</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="loader" id="loader" style="display:none;">
            <p>Loading more posts...</p>
        </div>
    </div>

    <div id="storyModal" class="modal">
        <div class="modal-content">
            <div class="progress-bar"><div class="progress"></div></div>
            <div id="storyContent"></div>
        </div>
    </div>
{% endif %}

<script>
    function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    let currentStoryIndex = 0;
    let storyTimer;
    let isPaused = false;
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;

    function openStoryModal(index) {
        currentStoryIndex = index;
        loadStory();
        document.getElementById('storyModal').style.display = 'flex';
        startProgress();
        document.addEventListener('touchstart', handleTouchStart);
        document.addEventListener('touchend', handleTouchEnd);
        document.addEventListener('mousedown', pauseStory);
        document.addEventListener('mouseup', resumeStory);
    }

    function closeStoryModal() {
        document.getElementById('storyModal').style.display = 'none';
        clearTimeout(storyTimer);
        document.querySelector('.progress').style.width = '0%';
        document.removeEventListener('touchstart', handleTouchStart);
        document.removeEventListener('touchend', handleTouchEnd);
        document.removeEventListener('mousedown', pauseStory);
        document.removeEventListener('mouseup', resumeStory);
    }

    function loadStory() {
        let stories = document.querySelectorAll('.story-item:not(.add-story)');
        let story = stories[currentStoryIndex];
        let type = story.dataset.type;
        let path = story.dataset.path;
        let content = '';
        if (type === 'image') {
            content = `<img src="${path}" alt="Story">`;
        } else if (type === 'video') {
            content = `<video src="${path}" autoplay loop></video>`;
        } else if (type === 'audio') {
            content = `<audio src="${path}" autoplay></audio>`;
        }
        document.getElementById('storyContent').innerHTML = content;
    }

    function startProgress(duration = 5000) {
        let progress = document.querySelector('.progress');
        progress.style.width = '0%';
        progress.style.transition = `width ${duration/1000}s linear`;
        setTimeout(() => { progress.style.width = '100%'; }, 10);
        storyTimer = setTimeout(nextStory, duration);
    }

    function nextStory() {
        let stories = document.querySelectorAll('.story-item:not(.add-story)');
        currentStoryIndex = (currentStoryIndex + 1) % stories.length;
        loadStory();
        startProgress();
    }

    function prevStory() {
        let stories = document.querySelectorAll('.story-item:not(.add-story)');
        currentStoryIndex = (currentStoryIndex - 1 + stories.length) % stories.length;
        loadStory();
        startProgress();
    }

    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        pauseStory();
    }

    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        let deltaX = touchEndX - touchStartX;
        let deltaY = touchEndY - touchStartY;
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX > 0) {
                prevStory();
            } else {
                nextStory();
            }
        } else if (deltaY > 50) {
            closeStoryModal();
        } else {
            resumeStory();
        }
    }

    function pauseStory() {
        isPaused = true;
        clearTimeout(storyTimer);
        document.querySelector('.progress').style.transition = 'none';
    }

    function resumeStory() {
        isPaused = false;
        let progress = document.querySelector('.progress');
        let remaining = (100 - parseFloat(progress.style.width)) / 100 * 5000;
        startProgress(remaining);
    }

    function addStory() {
        window.location.href = '{{ url_for('create_story') }}';
    }

    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
            loadMorePosts();
        }
    });

    let page = 1;
    function loadMorePosts() {
        let loader = document.getElementById('loader');
        loader.style.display = 'block';
        fetch(`/api/posts?page=${++page}`)
            .then(response => response.json())
            .then(data => {
                let container = document.getElementById('posts-container');
                data.posts.forEach(post => {
                    let postHtml = `
                    <div class="post">
                        <div class="post-header">
                            <img src="${post.user_profile_photo || '/static/img/default_profile.png'}" alt="Profile">
                            <div>
                                <h3>${post.user_real_name} <small>@${post.username}</small></h3>
                                <small>${new Date(post.timestamp).toLocaleString()}</small>
                            </div>
                        </div>
                        <div class="post-content">
                            <p>${post.description}</p>
                            ${post.media_path ? (post.media_type === 'image' ? `<img src="${post.media_path}" alt="Post Media" style="width:100%;">` : `<video src="${post.media_path}" controls style="width:100%;"></video>`) : ''}
                        </div>
                        <div class="post-actions">
                            <button>Like (${post.likes_count || 0})</button>
                            <button>Comment (${post.comments_count || 0})</button>
                            <button>Share</button>
                            <button>Follow</button>
                            <button>Save</button>
                            <button>Repost</button>
                            <button>Report</button>
                            <button>Hide</button>
                            <button>Notifications for this type</button>
                            <button>Block ${post.username}</button>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', postHtml);
                });
                loader.style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading posts:', error);
                loader.style.display = 'none';
            });
    }
</script>
{% endblock %}
