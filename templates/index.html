{% extends "base.html" %}

{% block title %}Home - SociaFam{% endblock %}

{% block extra_css %}
<style>
    .stories-container {
        display: flex;
        gap: 15px;
        padding: 15px 0;
        overflow-x: auto;
    }
    
    .story {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
    }
    
    .story-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid #1877f2;
        padding: 2px;
        margin-bottom: 5px;
    }
    
    .story-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .story-username {
        font-size: 12px;
        max-width: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .posts-container {
        margin-top: 20px;
    }
    
    .post-nav {
        display: flex;
        border-bottom: 1px solid #e4e6eb;
        margin-bottom: 20px;
    }
    
    .post-nav-item {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .post-nav-item.active {
        border-bottom-color: #1877f2;
        color: #1877f2;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Stories -->
    <div class="stories-container">
        {% for story in stories %}
        <div class="story" data-bs-toggle="modal" data-bs-target="#storyModal" data-user-id="{{ story.author.id }}">
            <div class="story-avatar">
                <img src="{{ url_for('get_profile_image', user_id=story.author.id) }}" alt="{{ story.author.username }}">
            </div>
            <div class="story-username">{{ story.author.username }}</div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Posts Navigation -->
    <div class="post-nav">
        <div class="post-nav-item active" data-tab="for-you">For You</div>
        <div class="post-nav-item" data-tab="following">Following</div>
        <div class="post-nav-item" data-tab="explore">Explore</div>
    </div>
    
    <!-- Posts Container -->
    <div id="postsContainer" class="posts-container">
        {% for post in posts %}
        <div class="post" data-post-id="{{ post.id }}">
            <div class="card">
                <div class="card-header">
                    <img src="{{ url_for('get_profile_image', user_id=post.author.id) }}" alt="{{ post.author.username }}" class="profile-img">
                    <div>
                        <strong>{{ post.author.real_name or post.author.username }}</strong>
                        <div>@{{ post.author.username }}</div>
                    </div>
                    <span class="relative-time" data-time="{{ post.created_at.isoformat() }}">{{ post.created_at|timesince }}</span>
                </div>
                
                <div class="card-body">
                    {% if post.content %}
                    <p>{{ post.content }}</p>
                    {% endif %}
                    
                    {% if post.image %}
                    <img src="{{ url_for('get_post_image', post_id=post.id) }}" class="post-img" alt="Post image" onclick="showImageModal(this.src)">
                    {% endif %}
                    
                    {% if post.video %}
                    <video src="{{ url_for('get_post_video', post_id=post.id) }}" class="post-video" controls></video>
                    {% endif %}
                </div>
                
                <div class="card-footer">
                    <div class="post-actions">
                        <button class="post-action like-btn {% if post in current_user.likes %}active{% endif %}" data-post-id="{{ post.id }}">
                            <i class="{% if post in current_user.likes %}fas{% else %}far{% endif %} fa-heart"></i>
                            <span>{{ post.likes.count() }}</span>
                        </button>
                        
                        <button class="post-action comment-btn" data-post-id="{{ post.id }}">
                            <i class="far fa-comment"></i>
                            <span>{{ post.comments.count() }}</span>
                        </button>
                        
                        <button class="post-action share-btn" data-post-id="{{ post.id }}">
                            <i class="far fa-share-square"></i>
                        </button>
                        
                        <button class="post-action save-btn" data-post-id="{{ post.id }}">
                            <i class="far fa-bookmark"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Story Modal -->
<div class="modal fade" id="storyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <div class="story-viewer">
                    <div id="storyProgress" class="d-flex p-2"></div>
                    
                    <div class="story-media">
                        <img id="storyImage" src="" alt="Story" style="display: none; width: 100%;">
                        <video id="storyVideo" src="" style="display: none; width: 100%;" controls></video>
                    </div>
                    
                    <div class="story-info p-3">
                        <div class="d-flex align-items-center">
                            <img id="storyUserAvatar" src="" alt="User" class="profile-img me-2">
                            <div>
                                <div id="storyUsername"></div>
                                <div id="storyTime" class="small text-muted"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="modalImage" src="" alt="Image" style="width: 100%;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/stories.js') }}"></script>
<script src="{{ url_for('static', filename='js/infinite-scroll.js') }}"></script>

<script>
    // Handle post navigation
    document.querySelectorAll('.post-nav-item').forEach(item => {
        item.addEventListener('click', function() {
            // Remove active class from all items
            document.querySelectorAll('.post-nav-item').forEach(i => i.classList.remove('active'));
            
            // Add active class to clicked item
            this.classList.add('active');
            
            // Load posts for this tab
            const tab = this.dataset.tab;
            loadPosts(tab);
        });
    });
    
    function loadPosts(tab) {
        // In a real implementation, this would fetch posts for the selected tab
        console.log('Loading posts for tab:', tab);
    }
</script>
{% endblock %}
