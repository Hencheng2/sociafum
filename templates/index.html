{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<style>
    /* Custom CSS specific to the Home page for better control and aesthetics */
    body {
        background-color: var(--bg-light); /* Tailwind-like variable for light mode */
        color: var(--text-light); /* Tailwind-like variable for light mode */
    }
    .dark body {
        background-color: var(--bg-dark); /* Tailwind-like variable for dark mode */
        color: var(--text-dark); /* Tailwind-like variable for dark mode */
    }

    /* Fixed Top Section for Stories and Search/Create Post */
    .top-section-fixed {
        position: sticky;
        top: 0;
        z-index: 30; /* Below main navbar, above scrollable content */
        background-color: var(--bg-light);
        padding-top: 1rem;
        padding-bottom: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: background-color 0.3s ease;
    }
    .dark .top-section-fixed {
        background-color: var(--bg-dark);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* What's on your mind / Create Post input */
    .whats-on-mind-input {
        background-color: #f0f2f5; /* Light gray */
        border: 1px solid #e0e0e0; /* Subtle border */
        color: #606770; /* Gray text */
    }
    .dark .whats-on-mind-input {
        background-color: #3a3b3c; /* Dark gray */
        border: 1px solid #4d4d4e;
        color: #b0b3b8;
    }

    /* Post Card Styling */
    .post-card {
        background-color: white;
        transition: background-color 0.3s ease;
    }
    .dark .post-card {
        background-color: #242526;
    }
    .post-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Action Buttons */
    .action-button {
        transition: color 0.2s, transform 0.2s;
        /* Default color for action icons */
        color: #606770;
    }

    .dark .action-button {
        color: #b0b3b8;
    }

    /* Specific button colors on hover/active */
    .action-button.like-button:hover {
        color: #1877f2; /* Facebook Blue */
    }
    .action-button.comment-button:hover {
        color: #4CAF50; /* Green */
    }
    .action-button.share-button:hover {
        color: #FF5722; /* Orange */
    }
    .action-button.repost-button:hover {
        color: #00bcd4; /* Cyan */
    }
    .action-button.save-button:hover {
        color: #ff9800; /* Amber */
    }
    .action-button.follow-button:hover {
        color: #9c27b0; /* Purple */
    }

    /* Modal Styling */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 100; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        border-radius: 1rem;
    }
    .dark .modal-content {
        background-color: #242526;
        color: white;
    }
    .close-modal {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-modal:hover, .close-modal:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .dark .close-modal:hover, .dark .close-modal:focus {
        color: white;
    }

    /* Toast Notification */
    .toast-notification {
        visibility: hidden; /* Hidden by default. Visible on click */
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 17px;
        border-radius: 0.5rem;
    }
    .toast-notification.show {
        visibility: visible;
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }
    @-webkit-keyframes fadein {
        from {bottom: 0; opacity: 0;}
        to {bottom: 30px; opacity: 1;}
    }
    @keyframes fadein {
        from {bottom: 0; opacity: 0;}
        to {bottom: 30px; opacity: 1;}
    }
    @-webkit-keyframes fadeout {
        from {bottom: 30px; opacity: 1;}
        to {bottom: 0; opacity: 0;}
    }
    @keyframes fadeout {
        from {bottom: 30px; opacity: 1;}
        to {bottom: 0; opacity: 0;}
    }
</style>

<div class="top-section-fixed w-full flex flex-col items-center">
    <!-- Stories Carousel Placeholder -->
    <div class="stories-carousel w-full overflow-x-auto flex space-x-4 p-4">
        <!-- Story item placeholder -->
        <div class="story-item flex flex-col items-center flex-shrink-0">
            <div class="w-16 h-16 bg-gray-300 rounded-full border-2 border-blue-500 flex items-center justify-center text-center text-xs">
                +<br>New
            </div>
            <span class="mt-1 text-xs text-gray-600 dark:text-gray-400">Your Story</span>
        </div>
        <!-- Repeat for other stories -->
        <div class="story-item flex flex-col items-center flex-shrink-0">
            <div class="w-16 h-16 bg-gray-300 rounded-full border-2 border-transparent"></div>
            <span class="mt-1 text-xs text-gray-600 dark:text-gray-400">User 1</span>
        </div>
    </div>

    <!-- What's on your mind? / Create Post Section -->
    <div class="w-full max-w-2xl px-4 py-2 flex items-center bg-white dark:bg-zinc-800 rounded-xl shadow-sm my-4">
        <img src="{{ url_for('static', filename='uploads/profile_photos/default.png') }}" class="w-10 h-10 rounded-full mr-4" alt="User Profile">
        <input type="text" placeholder="What's on your mind?" class="whats-on-mind-input w-full p-2 rounded-full cursor-pointer transition-colors duration-200" onclick="window.location.href='{{ url_for('create_post') }}'">
    </div>
</div>

<!-- Main Feed Container -->
<div id="posts-container" class="w-full max-w-2xl mx-auto py-4 space-y-4">
    <!-- Posts will be dynamically inserted here by JavaScript -->
</div>

<!-- Post template to be used by JavaScript -->
<template id="post-template">
    <div class="post-card p-4 rounded-xl shadow-md border border-gray-200 dark:border-zinc-700">
        <!-- Post Header -->
        <div class="flex items-center space-x-3 mb-4">
            <img src="" class="post-profile-photo w-12 h-12 rounded-full object-cover border-2 border-blue-500" alt="Profile Photo">
            <div class="flex-grow">
                <a href="#" class="post-username font-semibold text-lg hover:underline"></a>
                <p class="post-timestamp text-sm text-gray-500 dark:text-gray-400"></p>
            </div>
            <div class="relative group">
                <button class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-zinc-700 rounded-lg shadow-xl z-20 hidden group-hover:block">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-600 rounded-t-lg" onclick="handleReport(this.dataset.itemId, this.dataset.itemType)">Report Post</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-600" onclick="handleHide(this.dataset.postId)">Hide Post</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-600 rounded-b-lg" onclick="handleBlockProfile(this.dataset.userId)">Block User</a>
                </div>
            </div>
        </div>

        <!-- Post Body -->
        <div class="post-content mb-4 text-gray-800 dark:text-gray-200">
            <p class="post-description mb-2"></p>
            <img src="" class="post-media-photo w-full rounded-lg my-2 hidden" alt="Post Photo">
            <video src="" class="post-media-video w-full rounded-lg my-2 hidden" controls></video>
        </div>

        <!-- Stats Section -->
        <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 mb-3 border-b pb-2 border-gray-200 dark:border-zinc-700">
            <div class="flex items-center space-x-2">
                <span id="likes-count-" class="likes-count">0</span>
                <span>Likes</span>
            </div>
            <div class="flex items-center space-x-2">
                <span id="comments-count-" class="comments-count">0</span>
                <span>Comments</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="views-count">0</span>
                <span>Views</span>
            </div>
        </div>

        <!-- Action Buttons Section -->
        <div class="flex justify-between items-center text-gray-500 dark:text-gray-400">
            <button class="flex items-center space-x-2 action-button like-button" onclick="handleLike(this.dataset.postId)" data-post-id="">
                <i class="far fa-thumbs-up text-lg"></i>
                <span>Like</span>
            </button>
            <button class="flex items-center space-x-2 action-button comment-button" onclick="openCommentModal(this.dataset.postId)" data-post-id="">
                <i class="far fa-comment-alt text-lg"></i>
                <span>Comment</span>
            </button>
            <button class="flex items-center space-x-2 action-button share-button" onclick="handleShare(this.dataset.postId)" data-post-id="">
                <i class="far fa-share-square text-lg"></i>
                <span>Share</span>
            </button>
            <button class="flex items-center space-x-2 action-button save-button" onclick="handleSave(this.dataset.postId)" data-post-id="">
                <i class="far fa-bookmark text-lg"></i>
                <span>Save Post</span>
            </button>
            <button class="flex items-center space-x-2 action-button repost-button" onclick="handleRepost(this.dataset.postId)" data-post-id="">
                <i class="fas fa-retweet text-lg"></i>
                <span>Repost</span>
            </button>
        </div>
    </div>
</template>

<!-- Comment Modal -->
<div id="commentModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeCommentModal()">&times;</span>
        <h2 class="text-xl font-bold mb-4">Add a Comment</h2>
        <input type="hidden" id="comment-post-id">
        <textarea id="comment-text" class="w-full h-24 p-2 rounded-lg border dark:bg-zinc-800 dark:border-zinc-700" placeholder="Write your comment..."></textarea>
        <button class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="submitComment()">Post Comment</button>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeReportModal()">&times;</span>
        <h2 class="text-xl font-bold mb-4">Report Content</h2>
        <input type="hidden" id="report-item-id">
        <input type="hidden" id="report-item-type">
        <textarea id="report-reason" class="w-full h-24 p-2 rounded-lg border dark:bg-zinc-800 dark:border-zinc-700" placeholder="Explain why you are reporting this content..."></textarea>
        <button class="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600" onclick="submitReport()">Submit Report</button>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-notification" class="toast-notification"></div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to show a toast notification
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = 'toast-notification show';
            setTimeout(function(){
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }

        // --- Asynchronous JavaScript and XML (AJAX) functions for post actions ---

        async function handleLike(button) {
            const postId = button.dataset.postId;
            try {
                const response = await fetch(`/api/posts/${postId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message);
                    const likesCountElement = document.getElementById(`likes-count-${postId}`);
                    if (likesCountElement) {
                        likesCountElement.textContent = result.new_likes_count;
                    }
                    if (result.is_liked) {
                        button.classList.add('text-blue-500');
                        button.classList.remove('text-gray-500');
                    } else {
                        button.classList.add('text-gray-500');
                        button.classList.remove('text-blue-500');
                    }
                } else {
                    showToast(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        function openCommentModal(postId) {
            document.getElementById('comment-post-id').value = postId;
            document.getElementById('commentModal').style.display = 'block';
        }

        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            document.getElementById('comment-text').value = '';
        }

        async function submitComment() {
            const postId = document.getElementById('comment-post-id').value;
            const commentText = document.getElementById('comment-text').value;
            if (!commentText.trim()) {
                showToast('Comment cannot be empty.');
                return;
            }

            try {
                const response = await fetch(`/api/posts/${postId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment_text: commentText })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message);
                    closeCommentModal();
                    // Update the comments count on the page
                    const commentsCountElement = document.getElementById(`comments-count-${postId}`);
                    if (commentsCountElement) {
                        commentsCountElement.textContent = result.new_comments_count;
                    }
                } else {
                    showToast(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        async function handleShare(postId) {
            // Check if Web Share API is available
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Check out this post!',
                        text: `Take a look at this post: {{ url_for('post_detail', post_id=0) }}`.replace('0', postId),
                        url: window.location.href.split('?')[0]
                    });
                    console.log('Post shared successfully');
                } catch (error) {
                    console.error('Error sharing:', error);
                    showToast('Failed to share post.');
                }
            } else {
                // Fallback for browsers that don't support Web Share API
                showToast('Web Share API not supported. Copying link...');
                const postUrl = `{{ url_for('post_detail', post_id=0) }}`.replace('0', postId);
                const tempInput = document.createElement('input');
                tempInput.value = postUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showToast('Link copied to clipboard!');
            }
        }
        
        async function handleFollow(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/follow`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message);
                } else {
                    showToast(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        async function handleSave(button) {
            const postId = button.dataset.postId;
            try {
                const response = await fetch(`/api/posts/${postId}/save`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message);
                    if (result.is_saved) {
                        button.classList.add('text-orange-500');
                        button.classList.remove('text-gray-500');
                    } else {
                        button.classList.add('text-gray-500');
                        button.classList.remove('text-orange-500');
                    }
                } else {
                    showToast(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        async function handleRepost(postId) {
            try {
                const response = await fetch(`/api/posts/${postId}/repost`, { method: 'POST' });
                const result = await response.json();
                showToast(result.message);
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        function handleViewsAnalytics(postId) {
            // This would likely redirect to a dedicated analytics page for the post
            window.location.href = `{{ url_for('post_analytics', post_id=0) }}`.replace('0', postId);
        }

        function openReportModal(itemId, itemType) {
            document.getElementById('report-item-id').value = itemId;
            document.getElementById('report-item-type').value = itemType;
            document.getElementById('reportModal').style.display = 'block';
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            document.getElementById('report-reason').value = '';
        }

        async function submitReport() {
            const itemId = document.getElementById('report-item-id').value;
            const itemType = document.getElementById('report-item-type').value;
            const reason = document.getElementById('report-reason').value;
            if (!reason.trim()) {
                showToast('Please provide a reason for the report.');
                return;
            }

            try {
                const response = await fetch(`/api/${itemType}s/${itemId}/report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason })
                });
                const result = await response.json();
                showToast(result.message);
                closeReportModal();
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        async function handleHide(postId) {
            try {
                const response = await fetch(`/api/posts/${postId}/hide`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message);
                    // Optionally remove the post from the DOM
                    document.querySelector(`.post-card[data-post-id="${postId}"]`).style.display = 'none';
                } else {
                    showToast(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        async function handleNotifications(button) {
            const postId = button.dataset.postId;
            try {
                const response = await fetch(`/api/posts/${postId}/notifications`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message);
                    if (result.is_on) {
                        button.classList.add('text-green-500');
                    } else {
                        button.classList.remove('text-green-500');
                    }
                } else {
                    showToast(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        async function handleBlockProfile(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/block`, { method: 'POST' });
                const result = await response.json();
                showToast(result.message);
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        // --- Post Rendering and Initial Load ---
        async function loadAllPosts() {
            try {
                const response = await fetch('/api/posts');
                const posts = await response.json();
                const postsContainer = document.getElementById('posts-container');
                const template = document.getElementById('post-template');

                postsContainer.innerHTML = ''; // Clear existing posts
                
                posts.forEach(post => {
                    const postCard = template.content.cloneNode(true);
                    
                    // Populate post details
                    const profilePhoto = postCard.querySelector('.post-profile-photo');
                    profilePhoto.src = post.profile_photo || `{{ url_for('static', filename='uploads/profile_photos/default.png') }}`;
                    
                    const usernameLink = postCard.querySelector('.post-username');
                    usernameLink.href = `{{ url_for('profile', username=0) }}`.replace('0', post.username);
                    usernameLink.textContent = post.username;

                    const timestamp = postCard.querySelector('.post-timestamp');
                    timestamp.textContent = post.timestamp;

                    const description = postCard.querySelector('.post-description');
                    description.textContent = post.description;

                    // Handle media
                    const mediaPhoto = postCard.querySelector('.post-media-photo');
                    const mediaVideo = postCard.querySelector('.post-media-video');
                    if (post.media_type === 'photo' && post.media_path) {
                        mediaPhoto.src = post.media_path;
                        mediaPhoto.classList.remove('hidden');
                    } else if (post.media_type === 'video' && post.media_path) {
                        mediaVideo.src = post.media_path;
                        mediaVideo.classList.remove('hidden');
                    }

                    // Update stats
                    postCard.querySelector('.likes-count').textContent = post.likes_count;
                    postCard.querySelector('.comments-count').textContent = post.comments_count;
                    postCard.querySelector('.views-count').textContent = post.views_count;

                    // Set data attributes for buttons
                    const buttons = postCard.querySelectorAll('[data-post-id]');
                    buttons.forEach(button => button.dataset.postId = post.id);
                    
                    // Special cases
                    postCard.querySelector('.like-button').dataset.postId = post.id;
                    postCard.querySelector('.comment-button').dataset.postId = post.id;
                    postCard.querySelector('.repost-button').dataset.postId = post.id;
                    postCard.querySelector('.save-button').dataset.postId = post.id;
                    postCard.querySelector('.share-button').dataset.postId = post.id;
                    
                    // Append the populated card to the container
                    postsContainer.appendChild(postCard);
                });
            } catch (error) {
                console.error('Error fetching posts:', error);
            }
        }

        // --- Event Listeners for Dynamic Elements ---
        document.getElementById('posts-container').addEventListener('click', function(event) {
            const button = event.target.closest('[data-post-id]');
            if (button) {
                const postId = button.dataset.postId;
                if (button.classList.contains('like-button')) {
                    handleLike(button);
                } else if (button.classList.contains('comment-button')) {
                    openCommentModal(postId);
                } else if (button.classList.contains('share-button')) {
                    handleShare(postId);
                } else if (button.classList.contains('save-button')) {
                    handleSave(button);
                } else if (button.classList.contains('repost-button')) {
                    handleRepost(postId);
                }
            }
        });

        // --- Initial Load ---
        loadAllPosts();
    });
</script>
{% endblock %}
{% block footer %}{% endblock %}
