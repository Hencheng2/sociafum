{% extends 'base.html' %}

{% block title %}Settings{% endblock %}

{% block content %}
<style>
    /* Custom styles for the Settings page */
    body {
        padding-top: 0;
        padding-bottom: var(--navbar-height); /* Space for fixed bottom navbar */
        overflow-x: hidden;
    }

    .settings-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px 15px;
        background-color: var(--background-light);
    }

    .settings-card {
        background-color: var(--card-background);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow-medium);
        padding: 25px;
    }

    .settings-card h2 {
        text-align: center;
        color: var(--primary-text);
        margin-bottom: 30px;
        font-weight: 700;
        font-size: 2em;
    }

    .settings-section {
        margin-bottom: 30px;
    }

    .settings-section h3 {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 1.4em;
        border-bottom: 2px solid var(--primary-color-light);
        padding-bottom: 10px;
    }

    .settings-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px 0;
        border-bottom: 1px dashed var(--border-color-light);
    }
    .settings-item:last-child {
        border-bottom: none;
    }

    .settings-item label, .settings-item .form-label {
        flex-grow: 1;
        font-weight: 500;
        color: var(--primary-text);
        margin-bottom: 0;
    }

    .settings-item .form-control, .settings-item .form-select, .settings-item .form-check-input {
        flex-shrink: 0;
        margin-left: 15px;
    }

    .settings-item .form-check-input {
        width: 1.2em; /* Larger checkbox/toggle */
        height: 1.2em;
    }
    .settings-item .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .settings-item .toggle-switch {
        position: relative;
        display: inline-block;
        width: 45px;
        height: 25px;
        margin-left: 15px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--secondary-color-light); /* Off state */
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 25px;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .toggle-slider {
        background-color: var(--primary-color); /* On state */
    }
    input:focus + .toggle-slider {
        box-shadow: 0 0 1px var(--primary-color);
    }
    input:checked + .toggle-slider:before {
        -webkit-transform: translateX(20px);
        -ms-transform: translateX(20px);
        transform: translateX(20px);
    }

    .sub-settings-group {
        border-left: 3px solid var(--border-color-light);
        padding-left: 15px;
        margin-top: 15px;
        margin-bottom: 20px;
    }
    .sub-settings-group .settings-item {
        border-bottom: none; /* No extra border for sub-items */
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .sub-settings-group .settings-item label {
        font-weight: 400; /* Lighter font for sub-items */
        font-size: 0.9em;
    }
    .sub-settings-group .form-control, .sub-settings-group .form-select {
        width: auto; /* Allow auto width for dropdowns */
        min-width: 120px;
    }


    .btn-save-settings {
        display: block;
        width: fit-content;
        margin: 40px auto 0 auto;
        padding: 12px 30px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 25px;
        font-size: 1.1em;
        font-weight: 600;
        transition: background-color 0.2s ease, transform 0.2s ease;
        border: none;
    }
    .btn-save-settings:hover {
        background-color: darken(var(--primary-color), 10%);
        transform: translateY(-2px);
    }

    .back-to-menu-btn {
        display: block;
        width: fit-content;
        margin: 20px auto 0 auto;
        padding: 12px 30px;
        background-color: var(--button-bg-secondary);
        color: var(--button-text-secondary);
        border-radius: 25px;
        font-size: 1.1em;
        font-weight: 600;
        transition: background-color 0.2s ease, transform 0.2s ease;
        text-decoration: none;
    }
    .back-to-menu-btn:hover {
        background-color: darken(var(--button-bg-secondary), 10%);
        transform: translateY(-2px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .settings-container {
            margin: 15px auto;
            padding: 15px 10px;
        }
        .settings-card {
            padding: 20px;
        }
        .settings-card h2 {
            font-size: 1.8em;
            margin-bottom: 25px;
        }
        .settings-section h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        .settings-item {
            flex-direction: column; /* Stack label and control on small screens */
            align-items: flex-start;
            padding: 8px 0;
            margin-bottom: 10px;
        }
        .settings-item label, .settings-item .form-label {
            width: 100%;
            margin-bottom: 5px; /* Space between label and control */
        }
        .settings-item .form-control, .settings-item .form-select, .settings-item .form-check-input, .settings-item .toggle-switch {
            width: 100%;
            margin-left: 0;
            margin-right: 0;
            text-align: left;
        }
        .settings-item .toggle-switch {
            width: 45px; /* Keep toggle switch size */
            margin-top: 5px;
        }
        .sub-settings-group {
            padding-left: 10px;
        }
        .sub-settings-group .settings-item label {
            font-size: 0.85em;
        }
        .btn-save-settings, .back-to-menu-btn {
            padding: 10px 25px;
            font-size: 1em;
            margin-top: 30px;
        }
    }

    @media (max-width: 480px) {
        .settings-card {
            padding: 15px;
        }
        .settings-card h2 {
            font-size: 1.5em;
        }
        .settings-section h3 {
            font-size: 1.1em;
        }
        .settings-item label, .settings-item .form-label {
            font-size: 0.9em;
        }
        .settings-item .form-control, .settings-item .form-select {
            font-size: 0.9em;
            padding: 8px 12px;
        }
        .sub-settings-group .settings-item label {
            font-size: 0.8em;
        }
        .btn-save-settings, .back-to-menu-btn {
            padding: 8px 20px;
            font-size: 0.95em;
        }
    }
</style>

<div class="settings-container">
    <div class="settings-card">
        <h2>Settings</h2>

        <form id="userSettingsForm">
            {# General Settings #}
            <div class="settings-section">
                <h3><i class="fas fa-cogs me-2"></i> General</h3>
                <div class="settings-item">
                    <label for="language">Language</label>
                    <select class="form-select" id="language" name="language">
                        <option value="en" {% if user_settings.language == 'en' %}selected{% endif %}>English</option>
                        <option value="es" {% if user_settings.language == 'es' %}selected{% endif %}>Spanish</option>
                        <option value="fr" {% if user_settings.language == 'fr' %}selected{% endif %}>French</option>
                        {# Add more languages as needed #}
                    </select>
                </div>
                <div class="settings-item">
                    <label for="theme">Theme</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="theme" name="theme" {% if user_settings.theme == 'dark' %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="theme"></label>
                    </div>
                    <span class="ms-2">{{ user_settings.theme | capitalize }} Mode</span>
                </div>
            </div>

            {# Audience Visibility #}
            <div class="settings-section">
                <h3><i class="fas fa-eye me-2"></i> Audience & Visibility</h3>
                <div class="settings-item">
                    <label for="profileLocking">Profile Locking</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="profileLocking" name="profileLocking" {% if user_settings.profile_locking %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="profileLocking"></label>
                    </div>
                </div>
                <p class="text-muted small ms-auto mt-n2 mb-3">When enabled, users you don't follow can only see your profile photo and name.</p>

                <div class="settings-item">
                    <label for="postsVisibility">Posts Visibility</label>
                    <select class="form-select" id="postsVisibility" name="postsVisibility">
                        <option value="public" {% if user_settings.posts_visibility == 'public' %}selected{% endif %}>Everyone</option>
                        <option value="friends" {% if user_settings.posts_visibility == 'friends' %}selected{% endif %}>Friends Only</option>
                        <option value="private" {% if user_settings.posts_visibility == 'private' %}selected{% endif %}>Only Me</option>
                    </select>
                </div>
                <div class="sub-settings-group">
                    <div class="settings-item">
                        <label for="allowPostSharing">Allow Sharing of your Posts</label>
                        <div class="form-check form-switch toggle-switch">
                            <input class="form-check-input" type="checkbox" id="allowPostSharing" name="allowPostSharing" {% if user_settings.allow_post_sharing %}checked{% endif %}>
                            <label class="form-check-label toggle-slider" for="allowPostSharing"></label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label for="allowPostComments">Allow Comments on your Posts</label>
                        <div class="form-check form-switch toggle-switch">
                            <input class="form-check-input" type="checkbox" id="allowPostComments" name="allowPostComments" {% if user_settings.allow_post_comments %}checked{% endif %}>
                            <label class="form-check-label toggle-slider" for="allowPostComments"></label>
                        </div>
                    </div>
                </div>

                <div class="settings-item">
                    <label for="reelsVisibility">Reels Visibility</label>
                    <select class="form-select" id="reelsVisibility" name="reelsVisibility">
                        <option value="public" {% if user_settings.reels_visibility == 'public' %}selected{% endif %}>Everyone</option>
                        <option value="friends" {% if user_settings.reels_visibility == 'friends' %}selected{% endif %}>Friends Only</option>
                        <option value="private" {% if user_settings.reels_visibility == 'private' %}selected{% endif %}>Only Me</option>
                    </select>
                </div>
                <div class="sub-settings-group">
                    <div class="settings-item">
                        <label for="allowReelSharing">Allow Sharing of your Reels</label>
                        <div class="form-check form-switch toggle-switch">
                            <input class="form-check-input" type="checkbox" id="allowReelSharing" name="allowReelSharing" {% if user_settings.allow_reel_sharing %}checked{% endif %}>
                            <label class="form-check-label toggle-slider" for="allowReelSharing"></label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label for="allowReelComments">Allow Comments on your Reels</label>
                        <div class="form-check form-switch toggle-switch">
                            <input class="form-check-input" type="checkbox" id="allowReelComments" name="allowReelComments" {% if user_settings.allow_reel_comments %}checked{% endif %}>
                            <label class="form-check-label toggle-slider" for="allowReelComments"></label>
                        </div>
                    </div>
                </div>

                <div class="settings-item">
                    <label>Blocked Users</label>
                    <a href="{{ url_for('blocked_users') }}" class="btn btn-sm btn-info ms-auto">Manage <i class="fas fa-chevron-right ms-1"></i></a>
                </div>
            </div>

            {# Notifications Preferences #}
            <div class="settings-section">
                <h3><i class="fas fa-bell me-2"></i> Notifications</h3>
                <div class="settings-item">
                    <label for="notifyFriendRequests">Friend Requests</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="notifyFriendRequests" name="notifyFriendRequests" {% if user_settings.notify_friend_requests %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="notifyFriendRequests"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="notifyFriendAcceptance">Friend Acceptance</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="notifyFriendAcceptance" name="notifyFriendAcceptance" {% if user_settings.notify_friend_acceptance %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="notifyFriendAcceptance"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="notifyPostLikes">Likes on your Posts/Reels</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="notifyPostLikes" name="notifyPostLikes" {% if user_settings.notify_post_likes %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="notifyPostLikes"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="notifyNewMessages">New Messages</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="notifyNewMessages" name="notifyNewMessages" {% if user_settings.notify_new_messages %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="notifyNewMessages"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="notifyGroupInvites">Group Invitations</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="notifyGroupInvites" name="notifyGroupInvites" {% if user_settings.notify_group_invites %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="notifyGroupInvites"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="notifyComments">New Comments</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="notifyComments" name="notifyComments" {% if user_settings.notify_comments %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="notifyComments"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="notifyTags">Tags in Comments/Bios</label>
                    <div class="form-check form-switch toggle-switch">
                        <input class="form-check-input" type="checkbox" id="notifyTags" name="notifyTags" {% if user_settings.notify_tags %}checked{% endif %}>
                        <label class="form-check-label toggle-slider" for="notifyTags"></label>
                    </div>
                </div>
            </div>

            {# Save Settings Button #}
            <button type="submit" class="btn btn-save-settings">
                <i class="fas fa-save me-2"></i> Save Settings
            </button>
        </form>

        {# Back to Menu Link #}
        <a href="{{ url_for('menu') }}" class="btn back-to-menu-btn">
            <i class="fas fa-arrow-left me-2"></i> Back to Menu
        </a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userSettingsForm = document.getElementById('userSettingsForm');
        const themeToggle = document.getElementById('theme');
        const themeText = themeToggle.nextElementSibling.nextElementSibling; // Span after slider

        // Update theme text when toggle changes
        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                themeText.textContent = 'Dark Mode';
                document.body.classList.add('dark-theme'); // Apply dark theme class to body
                document.body.classList.remove('light-theme'); // Remove light theme
            } else {
                themeText.textContent = 'Light Mode';
                document.body.classList.remove('dark-theme'); // Remove dark theme
                document.body.classList.add('light-theme'); // Apply light theme
            }
        });

        // Initialize theme on page load based on Flask data
        if (themeToggle.checked) {
            document.body.classList.add('dark-theme');
            themeText.textContent = 'Dark Mode';
        } else {
            document.body.classList.add('light-theme');
            themeText.textContent = 'Light Mode';
        }


        // Handle form submission via AJAX
        userSettingsForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);
            const settingsData = {};
            for (let [key, value] of formData.entries()) {
                if (key === 'theme') {
                    settingsData[key] = themeToggle.checked ? 'dark' : 'light'; // Get actual theme value
                } else if (value === 'on') { // For checkboxes
                    settingsData[key] = true;
                } else {
                    settingsData[key] = value;
                }
            }
            // For unchecked checkboxes, they won't appear in FormData. Manually add as false.
            // This is important for toggles that can be explicitly turned off.
            // List all boolean settings that use toggles
            const booleanSettings = [
                'profileLocking', 'allowPostSharing', 'allowPostComments',
                'allowReelSharing', 'allowReelComments', 'notifyFriendRequests',
                'notifyFriendAcceptance', 'notifyPostLikes', 'notifyNewMessages',
                'notifyGroupInvites', 'notifyComments', 'notifyTags'
            ];
            booleanSettings.forEach(key => {
                if (!settingsData.hasOwnProperty(key)) {
                    settingsData[key] = false;
                }
            });

            console.log("Submitting settings:", settingsData);

            fetch('/api/settings/update', { // API endpoint for updating settings
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settingsData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Settings saved successfully!'); // Replace with custom modal
                    // Optionally, redirect or show a success message
                    // location.reload(); // Reload to reflect changes if necessary
                } else {
                    alert('Failed to save settings: ' + data.message); // Replace with custom modal
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('An error occurred while saving settings.'); // Replace with custom modal
            });
        });
    });
</script>
{% endblock %}
