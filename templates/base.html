<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SociaFam - {% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- IMPORTANT: All core, shared CSS is directly in this <style> block. -->
    <style>
        /* ===== GLOBAL RESET AND BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #e4e6eb; /* Default text color for dark theme */
            background: linear-gradient(135deg, #1f1c2c 0%, #2c3e50 100%); /* Dark theme by default */
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            /* padding-top will be dynamically adjusted by JavaScript based on navbar height */
            padding-top: 70px; /* Fallback/initial space for fixed top navbar */
            display: flex;
            flex-direction: column;
            border: 2px solid green; /* DEBUG: If you see this border, CSS IS working! */
        }

        /* ===== FIXED TOP NAVIGATION BAR (SINGLE-ROW LAYOUT) ===== */
        .navbar {
            display: flex; /* Use flexbox for a single row layout */
            justify-content: space-between; /* Pushes brand left, icons right */
            align-items: center; /* Vertically align all items */
            padding: 12px 20px; /* Padding for the entire navbar */
            background: rgba(36, 37, 38, 0.98); /* Dark background with slight transparency */
            backdrop-filter: blur(10px); /* Blurry effect */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Subtle bottom border */
            position: fixed; /* Keep navbar at the top */
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000; /* Ensure navbar stays on top of other content */
            width: 100%;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2); /* Soft shadow for depth */
            gap: 15px; /* Gap between major sections (brand, search, icons) */
        }

        .nav-brand {
            flex-shrink: 0; /* Prevent brand from shrinking */
        }

        .nav-brand a {
            font-size: 28px;
            font-weight: bold;
            color: #e4e6eb; /* Light color for brand text in dark theme */
            text-decoration: none;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap; /* Prevent brand text from wrapping */
        }

        .nav-search {
            flex-grow: 1; /* Allow search bar to take remaining space */
            max-width: 500px; /* Constrain max-width for aesthetic */
            display: flex; /* Use flex for input and button inside search */
            align-items: center;
            margin: 0 auto; /* **Centers the search bar within its flexible space** */
        }

        .nav-search form {
            flex-grow: 1; /* Form takes full width of search container */
            display: flex;
        }

        .nav-search input {
            flex: 1;
            padding: 8px 15px;
            border: 2px solid #3a3b3c;
            border-radius: 25px;
            font-size: 14px;
            background: rgba(58, 59, 60, 0.9);
            color: #e4e6eb;
            transition: all 0.3s ease;
        }

        .nav-search input::placeholder {
            color: #b0b3b8;
        }

        .nav-search input:focus {
            outline: none;
            border-color: #4a90e2; /* Adjusted blue for dark theme */
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .nav-search button {
            background: none;
            border: none;
            margin-left: -40px; /* Pull search icon into input field */
            cursor: pointer;
            color: #b0b3b8;
            padding: 5px;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        /* --- Right-Aligned Navigation Icons (Equally Spaced) --- */
        .nav-icons {
            display: flex;
            /* Using gap here instead of space-evenly for more control with many icons,
               while still maintaining distribution. Can switch to space-evenly if preferred. */
            gap: 10px; /* Space between icons */
            align-items: center;
            flex-shrink: 0; /* Prevent icons block from shrinking */
        }

        /* --- General Styling for ALL Nav Icons (including profile pic) --- */
        .nav-icon {
            color: #b0b3b8; /* Default icon color (light gray for dark theme) */
            text-decoration: none;
            width: 40px; /* **Standard icon size** */
            height: 40px; /* **Standard icon size** */
            font-size: 20px; /* Font Awesome icon size */
            position: relative;
            display: flex; /* Use flex to center icon content/profile pic */
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Circular shape */
            transition: all 0.3s ease; /* Smooth transitions for hover effects */
            background: rgba(58, 59, 60, 0.9); /* Icon background for dark theme */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            flex-shrink: 0; /* Prevent icons from shrinking too much */
        }

        .nav-icon:hover {
            background: #4a90e2; /* Vibrant blue on hover */
            color: white;
            transform: translateY(-2px); /* Slight lift effect */
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3); /* Enhanced shadow on hover */
        }

        /* Active state for icons (e.g., current page) */
        .nav-icon.active {
            color: #4a90e2; /* Active icon color */
        }
        .nav-icon.active .nav-profile-pic {
            border-color: #4a90e2; /* Active border for profile pic */
        }

        /* Badge for notifications/counts */
        .nav-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #ff4d4d, #ff8c8c); /* Vibrant red gradient */
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #363738; /* Border matches dark theme background */
        }

        /* Profile Picture specific styling (inside a nav-icon) */
        .nav-profile-pic {
            width: 100%; /* **Fill parent nav-icon for consistent sizing** */
            height: 100%; /* **Fill parent nav-icon for consistent sizing** */
            border-radius: 50%;
            object-fit: cover; /* Ensures image covers the area without distortion */
            border: 2px solid transparent; /* No border initially */
            transition: border-color 0.3s ease;
        }

        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            flex: 1; /* Allows it to grow and fill available vertical space */
            width: 100%;
            max-width: 1200px; /* Constrains content width for better readability on large screens */
            margin: 0 auto 20px; /* Centers content horizontally, adds bottom margin */
            padding: 20px; /* Internal padding */
            background: rgba(36, 37, 38, 0.95); /* Dark background for content cards */
            backdrop-filter: blur(10px);
            border-radius: 20px; /* Rounded corners for the content block */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); /* Deeper shadow for content block */
            min-height: calc(100vh - 90px); /* Ensures content area fills most of viewport, considering navbar height + bottom margin */
            color: #e4e6eb; /* Light text for dark theme content */
        }

        /* --- Flash Messages --- */
        .flash-messages { margin-bottom: 20px; }
        .flash {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-weight: 500;
            border: 2px solid transparent;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .flash-success { background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; border-color: #b8dfc2; }
        .flash-error { background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; border-color: #f1b0b7; }
        .flash-warning { background: linear-gradient(135deg, #fff3cd, #ffeaa7); color: #856404; border-color: #ffe082; }

        /* --- Card Styles (for posts/stories, etc.) --- */
        .dark-theme .card-header,
        .dark-theme .card-body,
        .dark-theme .card-footer { background-color: #363738; color: #e4e6eb; }
        .dark-theme .card { background: #363738; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); border-radius: 12px; margin-bottom: 20px; overflow: hidden;}
        .dark-theme .text-muted { color: #b0b3b8 !important; }
        .profile-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .card-header { display: flex; align-items: center; padding: 15px; gap: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .card-body { padding: 15px; }
        .card-footer { display: flex; justify-content: space-around; padding: 10px 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .post-img, .post-video { width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px; margin-top: 10px; background-color: black; }
        .post-actions { display: flex; justify-content: space-around; width: 100%; }
        .post-action {
            background: none; border: none; color: #b0b3b8; cursor: pointer; font-size: 18px;
            display: flex; align-items: center; gap: 5px; padding: 8px 12px;
            border-radius: 8px; transition: all 0.2s ease;
        }
        .post-action:hover { background-color: rgba(74, 144, 226, 0.1); color: #4a90e2; }
        .post-action.active { color: #4a90e2; }

        /* --- Story Viewer/Modal Styles --- */
        .story-viewer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .story-viewer { position: relative; width: 100%; max-width: 400px; height: 80vh; background-color: black; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; }
        .story-media { flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .story-info { position: absolute; top: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0)); color: white; display: flex; align-items: center; gap: 10px; }
        .story-user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* --- Generic Form/Button Styles --- */
        .btn { padding: 10px 15px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background-color: #4a90e2; color: white; border: none; }
        .btn-primary:hover { background-color: #357bd8; }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #555; border-radius: 8px;
            background-color: #3a3b3c; color: #e4e6eb;
        }
        .form-control:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); }

        /* ===== RESPONSIVE STYLES (Adjustments for Smaller Screens) ===== */
        @media (max-width: 768px) {
            body { padding-top: 60px; } /* Adjust padding for mobile navbar height */
            .navbar { padding: 8px 10px; gap: 10px; }
            .nav-brand a { font-size: 24px; }
            .nav-search { flex-basis: auto; /* Allow search to naturally size */ max-width: 250px; } /* Smaller max-width on mobile */
            .nav-icons { gap: 5px; } /* Reduced gap for icons on mobile */
            .nav-icon { width: 36px; height: 36px; font-size: 18px; } /* Smaller icons on mobile */
            .nav-badge { top: -3px; right: -3px; width: 16px; height: 16px; font-size: 10px; }
            .main-content { margin: 0 8px 15px; padding: 15px; border-radius: 16px; min-height: calc(100vh - 75px); }

            /* Other component-specific responsive rules */
            .stories-container { padding: 10px 0; }
            .story-img { width: 50px; height: 50px; }
            .post-img, .post-video { max-height: 300px; }
            .profile-info { flex-direction: column; align-items: center; text-align: center; }
            .profile-avatar { margin: 0 0 15px 0; }
            .profile-stats { justify-content: center; }
            .profile-actions { justify-content: center; }
            .profile-content { grid-template-columns: repeat(2, 1fr); }
            .friends-container { padding: 0 12px; }
            .friend-item { flex-direction: column; text-align: center; }
            .friend-avatar { margin: 0 0 12px 0; }
            .friend-actions { margin-top: 12px; justify-content: center; }
            .inbox-sidebar { width: 100%; }
            .inbox-main { display: none; }
            .chat-container { height: calc(100vh - 70px); }
            .menu-container { padding: 0 12px; }
            .admin-stats { grid-template-columns: repeat(2, 1fr); }
            .admin-table { font-size: 14px; }
            .admin-table th, .admin-table td { padding: 8px; }
            .admin-actions { flex-direction: column; gap: 6px; }
            .search-container { padding: 0 12px; }
            .search-form { flex-direction: column; }
            .search-input { border-radius: 22px; margin-bottom: 12px; }
            .search-button { border-radius: 22px; }
            .add-content-container { padding: 0 12px; }
            .add-content-types { flex-direction: column; gap: 12px; }
            .notifications-container { padding: 0 12px; }
            .story-viewer-info { top: 12px; left: 12px; right: 12px; }
            .story-viewer-actions { bottom: 12px; left: 12px; right: 12px; }
            .story-viewer-close { top: 12px; right: 12px; }
        }

        @media (max-width: 480px) {
            .nav-brand a { font-size: 20px; }
            .nav-icons { gap: 3px; }
            .nav-icon { font-size: 16px; width: 32px; height: 32px; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .profile-img { margin: 0 0 10px 0; }
            .post-actions { flex-wrap: wrap; gap: 8px; }
            .profile-content { grid-template-columns: 1fr; }
            .friends-tabs { flex-wrap: wrap; }
            .friends-tab { padding: 8px 12px; font-size: 14px; }
            .chat-input-container { padding: 12px; }
            .chat-input-action { margin-right: 12px; font-size: 18px; }
            .admin-stats { grid-template-columns: 1fr; }
            .admin-table { font-size: 13px; }
            .admin-table th, .admin-table td { padding: 8px; }
            .story-user-avatar { width: 32px; height: 32px; }
            .story-action { width: 36px; height: 36px; }
            .settings-option { flex-direction: column; align-items: flex-start; }
            .settings-option-action { margin: 10px 0 0 0; align-self: stretch; }
        }

        /* --- Accessibility Overrides --- */
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
        }
        @media (prefers-contrast: high) {
            .navbar { border-bottom: 2px solid #fff; }
            .card, .btn, .form-control { border: 2px solid #fff; }
        }
        @media (prefers-reduced-transparency: reduce) {
            .story-viewer-overlay { background-color: rgba(0, 0, 0, 0.95); }
        }
        @media print {
            .navbar, .card-footer, .post-actions, .settings-tabs, .settings-form-submit { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            body, .card { background-color: white !important; color: black !important; }
        }
    </style>
    {% endblock %}
</head>
<body class="{% if current_user.is_authenticated and current_user.theme == 'dark' %}dark-theme{% else %}dark-theme{% endif %}">
    <!-- Fixed Top Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">
            <a href="{{ url_for('index') }}">SociaFam</a>
        </div>
        
        <div class="nav-search">
            <form action="{{ url_for('search') }}" method="GET">
                <input type="text" name="q" placeholder="Search...">
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
        
        <div class="nav-icons">
            <a href="{{ url_for('index') }}" class="nav-icon active"><i class="fas fa-home"></i></a>
            <a href="{{ url_for('reels') }}" class="nav-icon"><i class="fas fa-film"></i></a>
            <a href="{{ url_for('friends') }}" class="nav-icon">
                <i class="fas fa-user-friends"></i>
                {% if current_user.is_authenticated and current_user.followers.filter_by(is_read=False).count() > 0 %}
                <span class="nav-badge">{{ current_user.followers.filter_by(is_read=False).count() }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('notifications') }}" class="nav-icon">
                <i class="fas fa-bell"></i>
                {% if current_user.is_authenticated and current_user.notifications.filter_by(is_read=False).count() > 0 %}
                <span class="nav-badge">{{ current_user.notifications.filter_by(is_read=False).count() }}</span>
                {% endif %}
            </a>
            <a href="{% if current_user.is_authenticated %}{{ url_for('profile', username=current_user.username) }}{% else %}{{ url_for('login') }}{% endif %}" class="nav-icon">
                {% if current_user.is_authenticated and current_user.profile_pic %}
                <img src="{{ url_for('get_profile_image', user_id=current_user.id) }}" alt="Profile" class="nav-profile-pic">
                {% else %}
                <img src="{{ url_for('static', filename='images/default-profile.png') }}" alt="Profile" class="nav-profile-pic">
                {% endif %}
            </a>
            <a href="{{ url_for('menu') }}" class="nav-icon"><i class="fas fa-bars"></i></a>
            {% if current_user.is_authenticated and current_user.is_admin %}
            <a href="{{ url_for('admin_dashboard') }}" class="nav-icon"><i class="fas fa-cog"></i></a>
            {% endif %}
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block extra_js %}{% endblock %}
    
    <script>
        // Adjust body padding-top dynamically based on navbar height to prevent content overlap
        document.addEventListener('DOMContentLoaded', function() {
            const navbar = document.querySelector('.navbar');
            const adjustPadding = () => {
                document.body.style.paddingTop = `${navbar.offsetHeight}px`;
            };

            // Initial adjustment
            adjustPadding();

            // Re-adjust on window resize
            window.addEventListener('resize', adjustPadding);

            // Re-adjust after images load (important if images in navbar affect its height)
            navbar.querySelectorAll('img').forEach(img => {
                if (!img.complete) {
                    img.addEventListener('load', adjustPadding);
                }
            });

            // Apply theme on page load (defaults to dark-theme in <body> class for immediate effect)
            {% if current_user.is_authenticated %}
            const theme = '{{ current_user.theme }}';
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme'); // Ensure light theme is removed if not dark
            }
            {% else %}
            // If not authenticated, ensure dark theme is applied as per request for base styling
            document.body.classList.add('dark-theme');
            {% endif %}

            // Simple active state logic for navigation icons
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-icons .nav-icon').forEach(icon => { // Corrected selector to .nav-icons
                icon.classList.remove('active'); // Remove active from all first
                const iconHref = icon.getAttribute('href');

                if (iconHref === currentPath) {
                    icon.classList.add('active');
                } else if (currentPath.startsWith('/profile/') && iconHref && iconHref.includes('/profile/')) {
                    // Special handling for profile page
                    icon.classList.add('active');
                } else if (currentPath === '/' && iconHref === '{{ url_for("index") }}') {
                    // Handle index/home explicitly if current path is root
                    icon.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
