{% extends 'base.html' %}

{% block title %}My Profile{% endblock %}

{% block content %}
<style>
    /* Custom styles for My Profile page */
    body {
        padding-top: 0;
        padding-bottom: var(--navbar-height); /* Space for fixed bottom navbar */
        overflow-x: hidden;
    }

    .profile-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px 15px;
        background-color: var(--background-light);
    }

    .profile-header {
        display: flex;
        align-items: flex-start;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .profile-photo-wrapper {
        flex-shrink: 0;
        position: relative;
    }

    .profile-photo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-color);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .change-photo-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        border: 2px solid white;
    }

    .profile-info {
        flex-grow: 1;
    }

    .username-follow {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .nav-tabs {
        display: flex;
        justify-content: space-around;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
        overflow-x: auto; /* Enable horizontal scrolling on small screens */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }

    .nav-tabs a {
        padding: 1rem;
        text-align: center;
        flex-grow: 1;
        white-space: nowrap; /* Prevent text from wrapping */
    }

    .nav-tabs a.active {
        color: #4f46e5;
        border-bottom: 2px solid #4f46e5;
        font-weight: 600;
    }

    .tab-content .content-section {
        display: none;
    }

    .tab-content .content-section.active {
        display: block;
    }

    .grid-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .grid-item {
        position: relative;
        padding-top: 100%;
        background-color: #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }

    .grid-item img, .grid-item video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
    }

    .reel-viewer {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }

    .reel-viewer video {
        max-width: 100%;
        max-height: 100%;
    }
</style>

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 border border-gray-200 dark:border-gray-700 max-w-4xl mx-auto">

        <div class="profile-header flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-8">
            <div class="profile-photo-wrapper">
                <img src="{{ profile_photo }}" alt="Profile Photo" class="profile-photo">
                <button class="change-photo-btn" onclick="document.getElementById('changePhotoModal').classList.remove('hidden')">
                    <i class="fas fa-camera"></i>
                </button>
            </div>

            <div class="profile-info text-center md:text-left">
                <div class="username-follow">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-gray-100">{{ current_user.username }}</h1>
                </div>
                <div class="stats text-sm text-gray-600 dark:text-gray-400">
                    <div class="stat-item text-center">
                        <span class="font-bold text-lg block text-gray-900 dark:text-gray-100">{{ posts|length }}</span>
                        <span>Posts</span>
                    </div>
                    <div class="stat-item text-center">
                        <span class="font-bold text-lg block text-gray-900 dark:text-gray-100">{{ stories|length }}</span>
                        <span>Stories</span>
                    </div>
                    <div class="stat-item text-center">
                        <span class="font-bold text-lg block text-gray-900 dark:text-gray-100">{{ followers|length }}</span>
                        <span>Followers</span>
                    </div>
                    <div class="stat-item text-center">
                        <span class="font-bold text-lg block text-gray-900 dark:text-gray-100">{{ following|length }}</span>
                        <span>Following</span>
                    </div>
                </div>
                <div class="bio mt-2 text-gray-800 dark:text-gray-200">
                    <p>{{ current_user_profile.bio }}</p>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center mt-8">
            <div class="nav-tabs flex w-full max-w-4xl border-b border-gray-200 dark:border-gray-700">
                <a href="#posts" class="tab-link active w-1/6 py-3 text-center text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200" data-tab="posts">
                    <i class="fas fa-th-large text-xl"></i>
                    <span class="hidden sm:inline ml-2">Posts</span>
                </a>
                <a href="#locked" class="tab-link w-1/6 py-3 text-center text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200" data-tab="locked">
                    <i class="fas fa-lock text-xl"></i>
                    <span class="hidden sm:inline ml-2">Locked</span>
                </a>
                <a href="#saved" class="tab-link w-1/6 py-3 text-center text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200" data-tab="saved">
                    <i class="fas fa-bookmark text-xl"></i>
                    <span class="hidden sm:inline ml-2">Saved</span>
                </a>
                <a href="#reposts" class="tab-link w-1/6 py-3 text-center text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200" data-tab="reposts">
                    <i class="fas fa-retweet text-xl"></i>
                    <span class="hidden sm:inline ml-2">Reposts</span>
                </a>
                <a href="#liked" class="tab-link w-1/6 py-3 text-center text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200" data-tab="liked">
                    <i class="fas fa-heart text-xl"></i>
                    <span class="hidden sm:inline ml-2">Liked</span>
                </a>
                <a href="#reels" class="tab-link w-1/6 py-3 text-center text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200" data-tab="reels">
                    <i class="fas fa-video text-xl"></i>
                    <span class="hidden sm:inline ml-2">Reels</span>
                </a>
            </div>
        </div>

        <div class="tab-content mt-8">

            <div id="posts-content" class="content-section active">
                <div class="grid-container">
                    {% for post in posts %}
                        <div class="grid-item">
                            {% if post.media_type == 'image' %}
                                <img src="{{ post.media_url }}" alt="Post Image" class="w-full h-full object-cover">
                            {% elif post.media_type == 'video' %}
                                <video src="{{ post.media_url }}" class="w-full h-full object-cover"></video>
                            {% endif %}
                        </div>
                    {% endfor %}
                    {% if not posts %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No posts to display.</p>
                    {% endif %}
                </div>
            </div>

            <div id="locked-content" class="content-section">
                <div class="grid-container">
                    {% for post in locked_posts %}
                        <div class="grid-item">
                            {% if post.media_type == 'image' %}
                                <img src="{{ post.media_url }}" alt="Locked Post Image" class="w-full h-full object-cover">
                            {% elif post.media_type == 'video' %}
                                <video src="{{ post.media_url }}" class="w-full h-full object-cover"></video>
                            {% endif %}
                        </div>
                    {% endfor %}
                    {% if not locked_posts %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No locked posts to display.</p>
                    {% endif %}
                </div>
            </div>

            <div id="saved-content" class="content-section">
                <div class="grid-container">
                    {% for post in saved_posts %}
                        <div class="grid-item">
                            {% if post.media_type == 'image' %}
                                <img src="{{ post.media_url }}" alt="Saved Post Image" class="w-full h-full object-cover">
                            {% elif post.media_type == 'video' %}
                                <video src="{{ post.media_url }}" class="w-full h-full object-cover"></video>
                            {% endif %}
                        </div>
                    {% endfor %}
                    {% if not saved_posts %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No saved posts to display.</p>
                    {% endif %}
                </div>
            </div>

            <div id="reposts-content" class="content-section">
                <div class="grid-container">
                    {% for post in reposts %}
                        <div class="grid-item">
                            {% if post.media_type == 'image' %}
                                <img src="{{ post.media_url }}" alt="Repost Image" class="w-full h-full object-cover">
                            {% elif post.media_type == 'video' %}
                                <video src="{{ post.media_url }}" class="w-full h-full object-cover"></video>
                            {% endif %}
                        </div>
                    {% endfor %}
                    {% if not reposts %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No reposts to display.</p>
                    {% endif %}
                </div>
            </div>

            <div id="liked-content" class="content-section">
                <div class="grid-container">
                    {% for post in liked_posts %}
                        <div class="grid-item">
                            {% if post.media_type == 'image' %}
                                <img src="{{ post.media_url }}" alt="Liked Post Image" class="w-full h-full object-cover">
                            {% elif post.media_type == 'video' %}
                                <video src="{{ post.media_url }}" class="w-full h-full object-cover"></video>
                            {% endif %}
                        </div>
                    {% endfor %}
                    {% if not liked_posts %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No liked posts to display.</p>
                    {% endif %}
                </div>
            </div>

            <div id="reels-content" class="content-section">
                <div class="grid-container">
                    {% for reel in reels %}
                        <div class="grid-item">
                            <video src="{{ reel.video_url }}" class="w-full h-full object-cover" data-bs-toggle="modal" data-bs-target="#reelViewerModal" data-reel-id="{{ reel.id }}"></video>
                        </div>
                    {% endfor %}
                    {% if not reels %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No reels to display.</p>
                    {% endif %}
                </div>
            </div>
            
            <div id="stories-content" class="content-section">
                <div class="grid-container">
                    {% for story in stories %}
                        <div class="grid-item">
                            <img src="{{ story.media_url }}" alt="Story Image" class="w-full h-full object-cover">
                        </div>
                    {% endfor %}
                    {% if not stories %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No stories to display.</p>
                    {% endif %}
                </div>
            </div>
            
            <div id="tagged-content" class="content-section">
                <div class="grid-container">
                    {% for post in tagged_posts %}
                        <div class="grid-item">
                            {% if post.media_type == 'image' %}
                                <img src="{{ post.media_url }}" alt="Post Image" class="w-full h-full object-cover">
                            {% elif post.media_type == 'video' %}
                                <video src="{{ post.media_url }}" class="w-full h-full object-cover"></video>
                            {% endif %}
                        </div>
                    {% endfor %}
                    {% if not tagged_posts %}
                        <p class="text-center text-gray-500 dark:text-gray-400 col-span-3">No tagged posts to display.</p>
                    {% endif %}
                </div>
            </div>

        </div>

    </div>
</div>

<div id="changePhotoModal" class="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 hidden transition-opacity duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-md p-6 transform transition-transform duration-300 scale-95">
            <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Change Profile Photo</h2>
            <form action="{{ url_for('upload_profile_photo') }}" method="post" enctype="multipart/form-data">
                <input type="file" name="profile_photo" id="profile_photo" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-gray-700 dark:file:text-gray-200 dark:hover:file:bg-gray-600">
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" onclick="document.getElementById('changePhotoModal').classList.add('hidden')">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="reelViewerModal" tabindex="-1" aria-labelledby="reelViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content dark:bg-gray-900">
            <div class="modal-header">
                <h5 class="modal-title" id="reelViewerModalLabel">Reel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 dark:bg-gray-900">
                <div class="reel-viewer text-center">
                    <div class="reel-header p-2 flex items-center dark:bg-gray-800">
                        <img id="reel-owner-profile-pic" src="" alt="Owner Profile" class="w-8 h-8 rounded-full">
                        <span id="reel-owner-username" class="ml-2 font-semibold dark:text-gray-200"></span>
                    </div>
                    <video id="reel-viewer-video" controls class="w-full" style="display: none;"></video>
                    <div class="reel-footer p-2 dark:bg-gray-800">
                        <p id="reel-caption" class="text-sm dark:text-gray-300"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching logic
        const tabLinks = document.querySelectorAll('.tab-link');
        const contentSections = document.querySelectorAll('.content-section');

        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove 'active' class from all links and content sections
                tabLinks.forEach(link => link.classList.remove('active'));
                contentSections.forEach(section => section.classList.remove('active'));

                // Add 'active' class to the clicked link
                this.classList.add('active');

                // Get the target content section ID from the data-tab attribute
                const targetId = this.getAttribute('data-tab');
                const targetSection = document.getElementById(targetId + '-content');

                // Add 'active' class to the corresponding content section
                if (targetSection) {
                    targetSection.classList.add('active');
                }
            });
        });

        // Reel viewer modal logic (from your original code)
        const reelViewerModalElement = document.getElementById('reelViewerModal');
        const reelViewerVideo = document.getElementById('reel-viewer-video');
        const reelOwnerProfilePic = document.getElementById('reel-owner-profile-pic');
        const reelOwnerUsername = document.getElementById('reel-owner-username');
        const reelCaption = document.getElementById('reel-caption');
        const allReels = {{ reels|tojson }};
        const reelMap = new Map();
        allReels.forEach(reel => reelMap.set(reel.id, reel));

        if (reelViewerModalElement) {
            reelViewerModalElement.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const reelId = button.getAttribute('data-reel-id');
                const reel = reelMap.get(parseInt(reelId));
                
                if (reel && reel.video_url) {
                    reelViewerVideo.src = reel.video_url;
                    reelOwnerProfilePic.src = reel.owner_profile_pic || '{{ url_for('static', filename='img/default_profile.png') }}';
                    reelOwnerUsername.textContent = '@' + (reel.owner_username || '{{ current_user.username }}');
                    reelCaption.textContent = reel.caption;
                    reelViewerVideo.style.display = 'block';
                    reelViewerVideo.play().catch(e => console.error("Video autoplay error:", e));
                } else {
                    console.error("Reel not found for ID:", reelId);
                }
            });

            reelViewerModalElement.addEventListener('hidden.bs.modal', function () {
                reelViewerVideo.pause();
                reelViewerVideo.currentTime = 0;
                reelViewerVideo.src = '';
                reelViewerVideo.style.display = 'none';
                reelOwnerProfilePic.src = '';
                reelOwnerUsername.textContent = '';
                reelCaption.textContent = '';
            });

            reelViewerModalElement.addEventListener('click', function(e) {
                if (e.target === reelViewerVideo) {
                    if (reelViewerVideo.paused) {
                        reelViewerVideo.play();
                    } else {
                        reelViewerVideo.pause();
                    }
                }
            });
        }
    });
</script>
{% endblock %}
