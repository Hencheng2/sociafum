{% extends 'base.html' %}

{% block title %}Friends{% endblock %}

{% block content %}



    
        
        
    

    
        <div class="friends-navbar d-flex align-items-center mb-4">
            <input type="text" id="user-search" class="form-control mr-3" placeholder="Search for users..." style="max-width: 300px;">
            <ul class="nav nav-tabs flex-grow-1">
                <li class="nav-item">
                    <a class="nav-link active" data-tab="followers" href="#">Followers ({{ followers|length }})</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="following" href="#">Following ({{ following|length }})</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="friends" href="#">Friends ({{ all_friends|length }})</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="requests" href="#">Friend requests ({{ friend_requests|length }})</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="suggested" href="#">Suggested</a>
                </li>
            </ul>
        </div>
    





    
        <div id="search-results" style="display: none;"></div>
    



    
        <div id="followers" class="tab-content">
            {% if followers %}
                {% for follower in followers %}
                
                    <div class="d-flex align-items-center mb-3">
                        <a href="{{ url_for('profile', username=follower.username) }}">
                            <img src="{{ follower.profilePhoto }}" alt="Profile" class="rounded-circle" width="50" height="50">
                        </a>
                        <div class="ml-3 flex-grow-1">
                            <a href="{{ url_for('profile', username=follower.username) }}" class="font-weight-bold">{{ follower.realName }}</a>
                            <br>
                            <small class="text-muted">{{ follower.mutual_count }} mutual friends/followers</small>
                        </div>
                        <button class="btn btn-sm btn-primary mr-2" onclick="startChat({{ follower.id }})"><i class="fa fa-message"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="blockUser({{ follower.id }})">Block</button>
                    </div>
                
                {% endfor %}
            {% else %}
                
                    No one is following you yet.

                    Share your profile with friends to get followers!

                

            {% endif %}
        </div>
    


    
        <div id="following" class="tab-content" style="display: none;">
            {% if following %}
                {% for user in following %}
                
                    <div class="d-flex align-items-center mb-3">
                        <a href="{{ url_for('profile', username=user.username) }}">
                            <img src="{{ user.profilePhoto }}" alt="Profile" class="rounded-circle" width="50" height="50">
                        </a>
                        <div class="ml-3 flex-grow-1">
                            <a href="{{ url_for('profile', username=user.username) }}" class="font-weight-bold">{{ user.realName }}</a>
                            <br>
                            <small class="text-muted">{{ user.mutual_count }} mutual friends/followers</small>
                        </div>
                        <button class="btn btn-sm btn-primary mr-2" onclick="startChat({{ user.id }})"><i class="fa fa-message"></i></button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-toggle="dropdown"></button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="unfollow({{ user.id }})">Unfollow</a>
                                <a class="dropdown-item" href="#" onclick="blockUser({{ user.id }})">Block</a>
                            </div>
                        </div>
                    </div>
                
                {% endfor %}
            {% else %}
                
                    No one is following you yet.

                    Follow people you know to see their posts and updates here.

                

            {% endif %}
        </div>
    


    
        <div id="friends" class="tab-content" style="display: none;">
            {% if all_friends %}
                {% for friend in all_friends %}
                
                    <div class="d-flex align-items-center mb-3">
                        <a href="{{ url_for('profile', username=friend.username) }}">
                            <img src="{{ friend.profilePhoto }}" alt="Profile" class="rounded-circle" width="50" height="50">
                        </a>
                        <div class="ml-3 flex-grow-1">
                            <a href="{{ url_for('profile', username=friend.username) }}" class="font-weight-bold">{{ friend.realName }}</a>
                            <br>
                            <small class="text-muted">{{ friend.mutual_count }} mutual friends/followers</small>
                        </div>
                        <button class="btn btn-sm btn-primary mr-2" onclick="startChat({{ friend.id }})"><i class="fa fa-message"></i></button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-toggle="dropdown"></button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="unfollow({{ friend.id }})">Unfollow</a>
                                <a class="dropdown-item" href="#" onclick="blockUser({{ friend.id }})">Block</a>
                            </div>
                        </div>
                    </div>
                
                {% endfor %}
            {% else %}
                
                    You have no friends yet.

                    Explore suggested users or use the search bar to find people.

                

            {% endif %}
        </div>
    

    
    
        <div id="requests" class="tab-content" style="display: none;">
            {% if friend_requests %}
                {% for request in friend_requests %}
                
                    <div class="d-flex align-items-center mb-3">
                        <a href="{{ url_for('profile', username=request.sender_username) }}">
                            <img src="{{ request.profilePhoto }}" alt="Profile" class="rounded-circle" width="50" height="50">
                        </a>
                        <div class="ml-3 flex-grow-1">
                            <a href="{{ url_for('profile', username=request.sender_username) }}" class="font-weight-bold">{{ request.sender_realName }}</a>
                            <br>
                            <small class="text-muted">{{ request.mutual_count }} mutual friends/followers</small>
                        </div>
                        <button class="btn btn-sm btn-success mr-2" onclick="acceptRequest({{ request.friendship_id }})">Accept</button>
                        <button class="btn btn-sm btn-secondary mr-2" onclick="declineRequest({{ request.friendship_id }})">Decline</button>
                        <button class="btn btn-sm btn-danger" onclick="blockUser({{ request.sender_id }})">Block</button>
                    </div>
                
                {% endfor %}
            {% else %}
                
                    You have no new friend requests.

                    Come back later or send some of your own!

                

            {% endif %}
        </div>
    


    
        <div id="suggested" class="tab-content" style="display: none;">
            {% if suggested_users %}
                {% for user in suggested_users %}
                
                    <div class="d-flex align-items-center mb-3">
                        <a href="{{ url_for('profile', username=user.username) }}">
                            <img src="{{ user.profilePhoto }}" alt="Profile" class="rounded-circle" width="50" height="50">
                        </a>
                        <div class="ml-3 flex-grow-1">
                            <a href="{{ url_for('profile', username=user.username) }}" class="font-weight-bold">{{ user.realName }}</a>
                            <br>
                            <small class="text-muted">{{ user.mutual_count }} mutual friends/followers</small>
                        </div>
                        <button class="btn btn-sm btn-primary mr-2" onclick="followUser({{ user.id }})">Follow</button>
                        <button class="btn btn-sm btn-secondary mr-2" onclick="removeSuggested({{ user.id }})">Remove</button>
                        <button class="btn btn-sm btn-danger" onclick="blockUser({{ user.id }})">Block</button>
                    </div>
                
                {% endfor %}
            {% else %}
                
                    No suggested users for now.

                    Check back later or search for people you may know.

                

            {% endif %}
        </div>
    





    <script>
        // Tab switching
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                document.getElementById(tab.dataset.tab).style.display = 'block';
                document.getElementById('search-results').style.display = 'none';
            });
        });

        // Search functionality
        const searchInput = document.getElementById('user-search');
        const searchResults = document.getElementById('search-results');
        const tabContents = document.querySelectorAll('.tab-content');

        searchInput.addEventListener('input', async () => {
            const query = searchInput.value.trim();
            if (query === '') {
                searchResults.style.display = 'none';
                // Show the active tab
                const activeTab = document.querySelector('.nav-link.active').dataset.tab;
                document.getElementById(activeTab).style.display = 'block';
                return;
            }
            searchResults.style.display = 'block';
            tabContents.forEach(tc => tc.style.display = 'none');

            const response = await fetch(`/api/search_users?q=${encodeURIComponent(query)}`);
            const users = await response.json();
            searchResults.innerHTML = users.map(user => `
                <div class="d-flex align-items-center mb-3">
                    <a href="/profile/${user.username}">
                        <img src="${user.profilePhoto}" alt="Profile" class="rounded-circle" width="50" height="50">
                    </a>
                    <div class="ml-3 flex-grow-1">
                        <a href="/profile/${user.username}" class="font-weight-bold">${user.realName}</a>
                        <br>
                        <small class="text-muted">${user.mutual_count} mutual friends/followers</small>
                    </div>
                    ${getButtonsForUser(user)}
                </div>
            `).join('');
        });

        function getButtonsForUser(user) {
            if (user.status === 'friend') {
                return `
                    <button class="btn btn-sm btn-primary mr-2" onclick="startChat(${user.id})"><i class="fa fa-message"></i></button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-toggle="dropdown"></button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="#" onclick="unfollow(${user.id})">Unfollow</a>
                            <a class="dropdown-item" href="#" onclick="blockUser(${user.id})">Block</a>
                        </div>
                    </div>
                `;
            } else if (user.status === 'pending_sent') {
                return `
                    <button class="btn btn-sm btn-warning mr-2" onclick="cancelRequest(${user.id})">Cancel Request</button>
                    <button class="btn btn-sm btn-danger" onclick="blockUser(${user.id})">Block</button>
                `;
            } else if (user.status === 'pending_received') {
                return `
                    <button class="btn btn-sm btn-success mr-2" onclick="acceptRequest(${user.id})">Accept</button>
                    <button class="btn btn-sm btn-secondary mr-2" onclick="declineRequest(${user.id})">Decline</button>
                    <button class="btn btn-sm btn-danger" onclick="blockUser(${user.id})">Block</button>
                `;
            } else {
                return `
                    <button class="btn btn-sm btn-primary mr-2" onclick="followUser(${user.id})">Follow</button>
                    <button class="btn btn-sm btn-danger" onclick="blockUser(${user.id})">Block</button>
                `;
            }
        }
    </script>

{% endblock %}
