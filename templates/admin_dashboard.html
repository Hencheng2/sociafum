{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<style>
    /* Admin Dashboard Specific Styles */
    body {
        --background-light: #2c2c2c; /* Darker background for admin */
        --card-background: #3a3a3a; /* Darker cards */
        --primary-text: #e0e0e0; /* Light text */
        --secondary-text: #aaaaaa; /* Lighter secondary text */
        --header-footer-bg: #1e1e1e; /* Even darker for fixed elements */
        --primary-color: #6200ea; /* Admin accent color (e.g., a deep purple) */
        --primary-color-light: #bb86fc; /* Lighter accent */
        --primary-color-dark: #3700b3; /* Darker accent */
        --success-color: #03dac6; /* Teal for success */
        --warning-color: #ffcc00; /* Amber for warning */
        --danger-color: #cf6679; /* Red for danger */
        --input-border-color: #555555;
        --border-color-light: #444444;
        --button-bg-secondary: #555555;
        --button-text-secondary: #e0e0e0;

        background-color: var(--background-light) !important;
        color: var(--primary-text) !important;
        padding-top: 0 !important; /* Override base.html padding */
        padding-bottom: 0 !important; /* Override base.html padding */
        overflow-x: hidden;
    }

    /* Override base navbar/footer for admin dashboard */
    .main-navbar, .main-footer {
        display: none !important;
    }

    .admin-dashboard-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* Full height */
        background-color: var(--background-light);
        color: var(--primary-text);
    }

    .admin-header {
        background-color: var(--header-footer-bg);
        color: white;
        padding: 15px 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        flex-shrink: 0;
    }
    .admin-header h1 {
        margin: 0;
        font-size: 2.2em;
        color: var(--primary-color-light);
    }

    .admin-content-wrapper {
        flex-grow: 1; /* Take all available space */
        overflow-y: auto; /* Make content scrollable */
        padding: 25px;
    }

    .admin-section {
        background-color: var(--card-background);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        padding: 25px;
        margin-bottom: 30px;
    }

    .admin-section h2 {
        color: var(--primary-color-light);
        font-weight: 700;
        margin-bottom: 25px;
        font-size: 1.8em;
        border-bottom: 2px solid var(--border-color-light);
        padding-bottom: 10px;
    }

    /* Overview Grid */
    .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .overview-card {
        background-color: var(--button-bg-secondary);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
    }
    .overview-card:hover {
        transform: translateY(-5px);
    }
    .overview-card .icon {
        font-size: 2.5em;
        color: var(--primary-color-light);
        margin-bottom: 10px;
    }
    .overview-card .count {
        font-size: 1.8em;
        font-weight: 700;
        color: var(--success-color);
        margin-bottom: 5px;
    }
    .overview-card .label {
        font-size: 0.9em;
        color: var(--secondary-text);
    }

    /* Filter and Search Bar */
    .filter-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .filter-bar .form-control, .filter-bar .form-select {
        background-color: var(--background-light);
        color: var(--primary-text);
        border: 1px solid var(--input-border-color);
        border-radius: 8px;
        padding: 8px 12px;
    }
    .filter-bar .form-control {
        flex-grow: 1;
    }
    .filter-bar .btn {
        background-color: var(--primary-color);
        color: white;
        border-radius: 8px;
        padding: 8px 15px;
    }

    /* Table Styling */
    .admin-table-responsive {
        overflow-x: auto;
    }
    .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .admin-table th, .admin-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color-light);
        color: var(--primary-text);
    }
    .admin-table th {
        background-color: var(--header-footer-bg);
        font-weight: 600;
        color: var(--primary-color-light);
        white-space: nowrap;
    }
    .admin-table tbody tr:hover {
        background-color: rgba(var(--primary-color-light-rgb), 0.1); /* Slight hover effect */
    }

    .admin-table .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border-color-light);
    }
    .admin-table .btn-action {
        background: none;
        border: 1px solid var(--button-bg-secondary);
        color: var(--secondary-text);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.85em;
        margin-right: 5px;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .admin-table .btn-action:hover {
        background-color: var(--primary-color);
        color: white;
    }
    .admin-table .btn-danger {
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    .admin-table .btn-danger:hover {
        background-color: var(--danger-color);
        color: white;
    }

    /* Admin Support Inbox Specifics */
    .support-chat-list-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 10px;
        background-color: var(--button-bg-secondary);
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        text-decoration: none;
        color: inherit;
        transition: background-color 0.2s ease;
    }
    .support-chat-list-item:hover {
        background-color: var(--primary-color-dark);
    }
    .support-chat-list-item .user-pic {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
        border: 2px solid var(--primary-color);
    }
    .support-chat-list-item .chat-details {
        flex-grow: 1;
        overflow: hidden;
    }
    .support-chat-list-item .chat-details .user-name {
        font-weight: 600;
        color: var(--primary-text);
        margin-bottom: 3px;
    }
    .support-chat-list-item .chat-details .last-message {
        font-size: 0.9em;
        color: var(--secondary-text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .support-chat-list-item .unread-badge {
        background-color: var(--danger-color);
        color: white;
        font-size: 0.8em;
        padding: 4px 8px;
        border-radius: 12px;
        margin-left: 10px;
        flex-shrink: 0;
    }

    /* Broadcast Message Section */
    .broadcast-form .form-control {
        background-color: var(--background-light);
        color: var(--primary-text);
        border: 1px solid var(--input-border-color);
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 15px;
        resize: vertical;
    }
    .broadcast-form .btn-primary {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.2s ease;
    }
    .broadcast-form .btn-primary:hover {
        background-color: darken(var(--primary-color), 10%);
    }

    /* Admin Story Post Section */
    .admin-story-form .form-control-file {
        display: block;
        margin-bottom: 15px;
        background-color: var(--background-light);
        color: var(--primary-text);
        border: 1px solid var(--input-border-color);
        border-radius: 8px;
        padding: 10px;
    }
    .admin-story-form .btn-primary {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.2s ease;
    }
    .admin-story-form .btn-primary:hover {
        background-color: darken(var(--primary-color), 10%);
    }

    /* Modal Styling */
    .modal-content {
        background-color: var(--card-background);
        color: var(--primary-text);
        border-radius: 12px;
    }
    .modal-header {
        background-color: var(--header-footer-bg);
        border-bottom: 1px solid var(--border-color-light);
        color: var(--primary-color-light);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }
    .modal-header .btn-close {
        filter: invert(1); /* White close button for dark header */
    }
    .modal-body {
        color: var(--primary-text);
    }
    .modal-footer {
        border-top: 1px solid var(--border-color-light);
        background-color: var(--header-footer-bg);
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
    }
    .modal-footer .btn-secondary {
        background-color: var(--button-bg-secondary);
        color: var(--button-text-secondary);
    }
    .modal-footer .btn-danger {
        background-color: var(--danger-color);
        color: white;
    }
    .modal-footer .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
        .admin-content-wrapper {
            padding: 20px;
        }
        .overview-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .admin-table th, .admin-table td {
            padding: 10px 12px;
            font-size: 0.9em;
        }
        .admin-table .profile-pic {
            width: 35px;
            height: 35px;
        }
        .admin-table .btn-action {
            padding: 4px 8px;
            font-size: 0.8em;
        }
    }

    @media (max-width: 768px) {
        .admin-header h1 {
            font-size: 1.8em;
        }
        .admin-content-wrapper {
            padding: 15px;
        }
        .admin-section h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .overview-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .overview-card .icon {
            font-size: 2em;
        }
        .overview-card .count {
            font-size: 1.5em;
        }
        .overview-card .label {
            font-size: 0.85em;
        }
        .filter-bar {
            flex-direction: column;
        }
        .filter-bar .form-control, .filter-bar .form-select, .filter-bar .btn {
            width: 100%;
        }
        .admin-table th, .admin-table td {
            padding: 8px 10px;
            font-size: 0.8em;
        }
        .admin-table .profile-pic {
            width: 30px;
            height: 30px;
        }
        .support-chat-list-item .user-pic {
            width: 40px;
            height: 40px;
        }
        .support-chat-list-item .chat-details .user-name {
            font-size: 1em;
        }
        .support-chat-list-item .chat-details .last-message {
            font-size: 0.8em;
        }
        .support-chat-list-item .unread-badge {
            font-size: 0.7em;
            padding: 3px 6px;
        }
    }

    @media (max-width: 480px) {
        .admin-header h1 {
            font-size: 1.5em;
        }
        .admin-content-wrapper {
            padding: 10px;
        }
        .admin-section {
            padding: 15px;
            margin-bottom: 20px;
        }
        .admin-section h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .overview-grid {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        .admin-table th, .admin-table td {
            font-size: 0.75em;
            padding: 6px 8px;
        }
    }
</style>

<div class="admin-dashboard-container">
    <div class="admin-header">
        <h1>SociaFam Admin Dashboard</h1>
    </div>

    <div class="admin-content-wrapper">

        {# Overall Metrics #}
        <div class="admin-section">
            <h2><i class="fas fa-chart-line me-2"></i> Overview</h2>
            <div class="overview-grid">
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-users"></i></div>
                    <div class="count">{{ counts.user_count }}</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-user-friends"></i></div>
                    <div class="count">{{ counts.group_count }}</div>
                    <div class="label">Total Groups</div>
                </div>
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-images"></i></div>
                    <div class="count">{{ counts.post_count }}</div>
                    <div class="label">Total Posts</div>
                </div>
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-video"></i></div>
                    <div class="count">{{ counts.reel_count }}</div>
                    <div class="label">Total Reels</div>
                </div>
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-history"></i></div>
                    <div class="count">{{ counts.story_count }}</div>
                    <div class="label">Total Stories</div>
                </div>
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-flag"></i></div>
                    <div class="count">{{ counts.pending_reports_count }}</div>
                    <div class="label">Pending Reports</div>
                </div>
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="count">{{ counts.active_warnings_count }}</div>
                    <div class="label">Active Warnings</div>
                </div>
                <div class="overview-card">
                    <div class="icon"><i class="fas fa-user-slash"></i></div>
                    <div class="count">{{ counts.active_bans_count }}</div>
                    <div class="label">Active Bans</div>
                </div>
            </div>
        </div>

        {# User Management #}
        <div class="admin-section">
            <h2><i class="fas fa-user-shield me-2"></i> User Management</h2>
            <div class="filter-bar">
                <input type="text" id="userSearchInput" class="form-control" placeholder="Search users by username or name">
                <select id="userFilterStatus" class="form-select">
                    <option value="all">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="warned">Warned</option>
                    <option value="banned">Banned</option>
                </select>
                <button type="button" class="btn" id="userFilterBtn"><i class="fas fa-filter"></i> Filter</button>
            </div>
            <div class="admin-table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Username</th>
                            <th>Real Name</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        {% for user in all_users %}
                        <tr data-user-id="{{ user.id }}" data-username="{{ user.username | lower }}" data-realname="{{ user.real_name | lower }}">
                            <td><img src="{{ user.profile_pic }}" alt="Profile" class="profile-pic"></td>
                            <td><a href="{{ url_for('profile', username=user.username) }}" class="text-white text-decoration-none">@{{ user.username }}</a></td>
                            <td>{{ user.real_name }}</td>
                            <td>
                                {% if user.is_banned %}
                                    <span class="badge bg-danger">Banned</span>
                                {% elif user.warnings_count > 0 %}
                                    <span class="badge bg-warning">Warned ({{ user.warnings_count }})</span>
                                {% else %}
                                    <span class="badge bg-success">Active</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn-action view-user-btn" data-user-id="{{ user.id }}"><i class="fas fa-eye"></i> View</button>
                                <button class="btn-action warn-user-btn" data-user-id="{{ user.id }}"><i class="fas fa-exclamation-circle"></i> Warn</button>
                                {% if user.is_banned %}
                                    <button class="btn-action unban-user-btn" data-user-id="{{ user.id }}"><i class="fas fa-check-circle"></i> Unban</button>
                                {% else %}
                                    <button class="btn-action ban-user-btn" data-user-id="{{ user.id }}"><i class="fas fa-user-slash"></i> Ban</button>
                                {% endif %}
                                <button class="btn-action btn-danger delete-user-btn" data-user-id="{{ user.id }}"><i class="fas fa-trash-alt"></i> Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# Group Management #}
        <div class="admin-section">
            <h2><i class="fas fa-users-cog me-2"></i> Group Management</h2>
            <div class="filter-bar">
                <input type="text" id="groupSearchInput" class="form-control" placeholder="Search groups by name">
                <select id="groupFilterStatus" class="form-select">
                    <option value="all">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="reported">Reported</option>
                    <option value="banned">Banned</option>
                </select>
                <button type="button" class="btn" id="groupFilterBtn"><i class="fas fa-filter"></i> Filter</button>
            </div>
            <div class="admin-table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Group Name</th>
                            <th>Members</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="groupTableBody">
                        {% for group in all_groups %}
                        <tr data-group-id="{{ group.id }}" data-groupname="{{ group.name | lower }}">
                            <td><img src="{{ group.profile_pic }}" alt="Group" class="profile-pic"></td>
                            <td><a href="{{ url_for('view_group_profile', group_id=group.id) }}" class="text-white text-decoration-none"><strong>{{ group.name }}</strong></a></td>
                            <td>{{ group.member_count }}</td>
                            <td>
                                {% if group.is_banned %}
                                    <span class="badge bg-danger">Banned</span>
                                {% elif group.reports_count > 0 %}
                                    <span class="badge bg-warning">Reported ({{ group.reports_count }})</span>
                                {% else %}
                                    <span class="badge bg-success">Active</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn-action view-group-btn" data-group-id="{{ group.id }}"><i class="fas fa-eye"></i> View</button>
                                {% if group.is_banned %}
                                    <button class="btn-action unban-group-btn" data-group-id="{{ group.id }}"><i class="fas fa-check-circle"></i> Unban</button>
                                {% else %}
                                    <button class="btn-action ban-group-btn" data-group-id="{{ group.id }}"><i class="fas fa-user-slash"></i> Ban</button>
                                {% endif %}
                                <button class="btn-action btn-danger delete-group-btn" data-group-id="{{ group.id }}"><i class="fas fa-trash-alt"></i> Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# Pending Reports #}
        <div class="admin-section">
            <h2><i class="fas fa-flag me-2"></i> Pending Reports</h2>
            <div class="admin-table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Reported Item</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Reported By</th>
                            <th>Timestamp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        {% for report in pending_reports %}
                        <tr data-report-id="{{ report.id }}" data-reported-item-id="{{ report.reported_item_id }}" data-reported-item-type="{{ report.type }}">
                            <td>
                                {% if report.type == 'user' %}
                                    User: <a href="{{ url_for('profile', username=report.reported_item_username) }}" class="text-white text-decoration-none">@{{ report.reported_item_username }}</a>
                                {% elif report.type == 'group' %}
                                    Group: <a href="{{ url_for('view_group_profile', group_id=report.reported_item_id) }}" class="text-white text-decoration-none">{{ report.reported_item_name }}</a>
                                {% elif report.type == 'post' %}
                                    Post (ID: {{ report.reported_item_id }})
                                {% elif report.type == 'reel' %}
                                    Reel (ID: {{ report.reported_item_id }})
                                {% elif report.type == 'story' %}
                                    Story (ID: {{ report.reported_item_id }})
                                {% endif %}
                            </td>
                            <td><span class="badge bg-info">{{ report.type | capitalize }}</span></td>
                            <td>{{ report.reason | truncate(50, True) }} <button class="btn-action btn-sm view-report-reason-btn" data-reason="{{ report.reason }}">View</button></td>
                            <td><a href="{{ url_for('profile', username=report.reported_by_username) }}" class="text-white text-decoration-none">@{{ report.reported_by_username }}</a></td>
                            <td>{{ moment(report.timestamp).fromNow() }}</td>
                            <td>
                                <button class="btn-action handle-report-warn-btn" data-report-id="{{ report.id }}" data-item-id="{{ report.reported_item_id }}" data-item-type="{{ report.type }}"><i class="fas fa-exclamation-circle"></i> Warn</button>
                                <button class="btn-action handle-report-ban-btn" data-report-id="{{ report.id }}" data-item-id="{{ report.reported_item_id }}" data-item-type="{{ report.type }}"><i class="fas fa-user-slash"></i> Ban</button>
                                <button class="btn-action handle-report-ignore-btn" data-report-id="{{ report.id }}"><i class="fas fa-check"></i> Ignore</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# Admin Support Inbox #}
        <div class="admin-section">
            <h2><i class="fas fa-headset me-2"></i> Support Inbox</h2>
            <div id="adminSupportInboxList">
                {% for chat in support_chats_overview %}
                    <a href="{{ url_for('admin_support_chat', chat_id=chat.id) }}" class="support-chat-list-item" data-chat-id="{{ chat.id }}">
                        <img src="{{ chat.user_profile_pic }}" alt="User Profile" class="user-pic">
                        <div class="chat-details">
                            <p class="user-name">{{ chat.user_real_name }} <span class="text-muted small">@{{ chat.user_username }}</span></p>
                            <p class="last-message">{{ chat.last_message_snippet }}</p>
                        </div>
                        {% if chat.unread_admin_messages_count > 0 %}
                            <span class="unread-badge">{{ chat.unread_admin_messages_count }}</span>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
            {% if not support_chats_overview %}
                <p class="text-center text-muted">No active support chats.</p>
            {% endif %}
        </div>

        {# Broadcast Message to All Users #}
        <div class="admin-section">
            <h2><i class="fas fa-bullhorn me-2"></i> Broadcast Message</h2>
            <form id="broadcastMessageForm" class="broadcast-form">
                <textarea class="form-control" id="broadcastMessageContent" rows="4" placeholder="Type message to all users..."></textarea>
                <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i> Send Broadcast</button>
            </form>
        </div>

        {# Post Admin Story (SociaFam Story) #}
        <div class="admin-section">
            <h2><i class="fas fa-history me-2"></i> Post SociaFam Story</h2>
            <form id="adminStoryForm" class="admin-story-form" enctype="multipart/form-data">
                <label for="adminStoryMedia" class="form-label">Story Media (Photo/Video max 30s)</label>
                <input type="file" class="form-control-file" id="adminStoryMedia" name="adminStoryMedia" accept="image/*,video/*">
                <div class="media-preview-area mb-3">
                    <img id="adminStoryImagePreview" class="media-preview" alt="Image Preview" style="display: none;">
                    <video id="adminStoryVideoPreview" class="media-preview" controls muted playsinline preload="metadata" style="display: none;"></video>
                    <p id="noAdminStoryMediaText">Select a photo or video for the SociaFam Story.</p>
                </div>
                <label for="adminStoryDescription" class="form-label">Description (Optional)</label>
                <textarea class="form-control mb-3" id="adminStoryDescription" name="adminStoryDescription" rows="2" placeholder="Add a short description..."></textarea>
                <button type="submit" class="btn btn-primary"><i class="fas fa-upload me-2"></i> Post Story</button>
            </form>
        </div>

    </div>
</div>


{# --- Modals for Admin Actions --- #}

{# Warn User Modal #}
<div class="modal fade" id="warnUserModal" tabindex="-1" aria-labelledby="warnUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="warnUserModalLabel">Issue Warning to User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Issuing warning to <strong id="warnUsernamePlaceholder"></strong>.</p>
                <div class="mb-3">
                    <label for="warningTitle" class="form-label">Warning Title</label>
                    <input type="text" class="form-control" id="warningTitle" placeholder="e.g., Inappropriate Content">
                </div>
                <div class="mb-3">
                    <label for="warningDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="warningDescription" rows="3" placeholder="Explain the violation..."></textarea>
                </div>
                <input type="hidden" id="warnUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmWarnUserBtn">Issue Warning</button>
            </div>
        </div>
    </div>
</div>

{# Ban User Modal #}
<div class="modal fade" id="banUserModal" tabindex="-1" aria-labelledby="banUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="banUserModalLabel">Ban User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Banning user: <strong id="banUsernamePlaceholder"></strong>.</p>
                <div class="mb-3">
                    <label for="banReason" class="form-label">Reason for Ban</label>
                    <textarea class="form-control" id="banReason" rows="3" placeholder="Explain the ban reason..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="banDuration">Ban Duration</label>
                    <select class="form-select" id="banDuration">
                        <option value="temporary">Temporary (specify days)</option>
                        <option value="permanent">Permanent</option>
                    </select>
                </div>
                <div class="mb-3" id="banDaysField" style="display: block;">
                    <label for="banDays" class="form-label">Number of Days</label>
                    <input type="number" class="form-control" id="banDays" value="7" min="1">
                </div>
                <input type="hidden" id="banUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmBanUserBtn">Confirm Ban</button>
            </div>
        </div>
    </div>
</div>

{# Delete User/Group/Content Confirmation Modal #}
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to permanently delete <strong id="deleteItemNamePlaceholder"></strong> (<span id="deleteItemTypePlaceholder"></span>)? This action is irreversible and all associated data will be lost.</p>
                <input type="hidden" id="deleteItemId">
                <input type="hidden" id="deleteItemType">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Permanently</button>
            </div>
        </div>
    </div>
</div>

{# View Report Reason Modal #}
<div class="modal fade" id="viewReportReasonModal" tabindex="-1" aria-labelledby="viewReportReasonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewReportReasonModalLabel">Report Reason</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="fullReportReasonContent"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
    // Define CSS variables for dark theme to ensure consistency
    document.documentElement.style.setProperty('--background-color', '#2c2c2c');
    document.documentElement.style.setProperty('--card-bg', '#3a3a3a');
    document.documentElement.style.setProperty('--text-color', '#e0e0e0');
    document.documentElement.style.setProperty('--secondary-text-color', '#aaaaaa');
    document.documentElement.style.setProperty('--header-footer-bg', '#1e1e1e');
    document.documentElement.style.setProperty('--primary-color', '#6200ea');
    document.documentElement.style.setProperty('--primary-color-light', '#bb86fc');
    document.documentElement.style.setProperty('--primary-color-dark', '#3700b3');
    document.documentElement.style.setProperty('--success-color', '#03dac6');
    document.documentElement.style.setProperty('--warning-color', '#ffcc00');
    document.documentElement.style.setProperty('--danger-color', '#cf6679');
    document.documentElement.style.setProperty('--input-border-color', '#555555');
    document.documentElement.style.setProperty('--border-color-light', '#444444');
    document.documentElement.style.setProperty('--button-bg-secondary', '#555555');
    document.documentElement.style.setProperty('--button-text-secondary', '#e0e0e0');

    document.addEventListener('DOMContentLoaded', function() {
        const adminDashboardContainer = document.querySelector('.admin-dashboard-container');
        if (adminDashboardContainer) {
            // Ensure the dark theme class is applied globally if needed
            document.body.classList.add('dark-theme');
        }

        // --- Filtering Logic for Users Table ---
        const userSearchInput = document.getElementById('userSearchInput');
        const userFilterStatus = document.getElementById('userFilterStatus');
        const userFilterBtn = document.getElementById('userFilterBtn');
        const userTableBody = document.getElementById('userTableBody');
        const allUsersRows = Array.from(userTableBody.querySelectorAll('tr')); // Capture all rows initially

        function filterUsers() {
            const searchTerm = userSearchInput.value.toLowerCase();
            const filterStatus = userFilterStatus.value;

            allUsersRows.forEach(row => {
                const username = row.dataset.username;
                const realname = row.dataset.realname;
                const statusBadge = row.querySelector('.badge');
                const userStatus = statusBadge ? statusBadge.textContent.toLowerCase().split(' ')[0] : 'active'; // e.g., "banned", "warned", "active"

                const matchesSearch = username.includes(searchTerm) || realname.includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || userStatus === filterStatus;

                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        userSearchInput.addEventListener('input', filterUsers);
        userFilterStatus.addEventListener('change', filterUsers);
        userFilterBtn.addEventListener('click', filterUsers);


        // --- Filtering Logic for Groups Table ---
        const groupSearchInput = document.getElementById('groupSearchInput');
        const groupFilterStatus = document.getElementById('groupFilterStatus');
        const groupFilterBtn = document.getElementById('groupFilterBtn');
        const groupTableBody = document.getElementById('groupTableBody');
        const allGroupsRows = Array.from(groupTableBody.querySelectorAll('tr')); // Capture all rows initially

        function filterGroups() {
            const searchTerm = groupSearchInput.value.toLowerCase();
            const filterStatus = groupFilterStatus.value;

            allGroupsRows.forEach(row => {
                const groupname = row.dataset.groupname;
                const statusBadge = row.querySelector('.badge');
                const groupStatus = statusBadge ? statusBadge.textContent.toLowerCase().split(' ')[0] : 'active'; // e.g., "banned", "reported", "active"

                const matchesSearch = groupname.includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || groupStatus === filterStatus;

                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        groupSearchInput.addEventListener('input', filterGroups);
        groupFilterStatus.addEventListener('change', filterGroups);
        groupFilterBtn.addEventListener('click', filterGroups);


        // --- Admin Action Modals & Buttons ---
        const warnUserModal = new bootstrap.Modal(document.getElementById('warnUserModal'));
        const warnUsernamePlaceholder = document.getElementById('warnUsernamePlaceholder');
        const warnUserIdInput = document.getElementById('warnUserId');
        const warningTitleInput = document.getElementById('warningTitle');
        const warningDescriptionInput = document.getElementById('warningDescription');
        const confirmWarnUserBtn = document.getElementById('confirmWarnUserBtn');

        const banUserModal = new bootstrap.Modal(document.getElementById('banUserModal'));
        const banUsernamePlaceholder = document.getElementById('banUsernamePlaceholder');
        const banUserIdInput = document.getElementById('banUserId');
        const banReasonInput = document.getElementById('banReason');
        const banDurationSelect = document.getElementById('banDuration');
        const banDaysField = document.getElementById('banDaysField');
        const banDaysInput = document.getElementById('banDays');
        const confirmBanUserBtn = document.getElementById('confirmBanUserBtn');

        const deleteConfirmationModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        const deleteItemNamePlaceholder = document.getElementById('deleteItemNamePlaceholder');
        const deleteItemTypePlaceholder = document.getElementById('deleteItemTypePlaceholder');
        const deleteItemIdInput = document.getElementById('deleteItemId');
        const deleteItemTypeInput = document.getElementById('deleteItemType');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        const viewReportReasonModal = new bootstrap.Modal(document.getElementById('viewReportReasonModal'));
        const fullReportReasonContent = document.getElementById('fullReportReasonContent');

        // Toggle ban duration field
        banDurationSelect.addEventListener('change', function() {
            if (this.value === 'temporary') {
                banDaysField.style.display = 'block';
            } else {
                banDaysField.style.display = 'none';
            }
        });

        // --- Event Delegation for User/Group/Report Actions ---
        document.body.addEventListener('click', function(event) {
            // Warn User
            if (event.target.classList.contains('warn-user-btn')) {
                const userId = event.target.dataset.userId;
                const username = event.target.closest('tr').dataset.username;
                warnUsernamePlaceholder.textContent = `@${username}`;
                warnUserIdInput.value = userId;
                warningTitleInput.value = '';
                warningDescriptionInput.value = '';
                warnUserModal.show();
            }

            // Ban User
            if (event.target.classList.contains('ban-user-btn')) {
                const userId = event.target.dataset.userId;
                const username = event.target.closest('tr').dataset.username;
                banUsernamePlaceholder.textContent = `@${username}`;
                banUserIdInput.value = userId;
                banReasonInput.value = '';
                banDurationSelect.value = 'temporary';
                banDaysInput.value = 7;
                banDaysField.style.display = 'block';
                banUserModal.show();
            }

            // Unban User
            if (event.target.classList.contains('unban-user-btn')) {
                const userId = event.target.dataset.userId;
                const username = event.target.closest('tr').dataset.username;
                if (confirm(`Are you sure you want to unban user @${username}?`)) {
                    sendAdminAction(`/api/admin/unban_user/${userId}`, 'POST', {}, 'User unbanned successfully!');
                }
            }

            // Delete User
            if (event.target.classList.contains('delete-user-btn')) {
                const userId = event.target.dataset.userId;
                const username = event.target.closest('tr').dataset.username;
                deleteItemNamePlaceholder.textContent = `@${username}`;
                deleteItemTypePlaceholder.textContent = 'User Account';
                deleteItemIdInput.value = userId;
                deleteItemTypeInput.value = 'user';
                deleteConfirmationModal.show();
            }

            // View Group
            if (event.target.classList.contains('view-group-btn')) {
                const groupId = event.target.dataset.groupId;
                // Redirect to view_group_profile with a special admin flag
                window.location.href = `{{ url_for('view_group_profile', group_id='') }}${groupId}?admin_view=true`;
            }

            // Ban Group
            if (event.target.classList.contains('ban-group-btn')) {
                const groupId = event.target.dataset.groupId;
                const groupName = event.target.closest('tr').dataset.groupname;
                // Similar ban logic, but use a generic modal or a dedicated one if complexity increases
                if (confirm(`Are you sure you want to ban group "${groupName}"?`)) {
                    sendAdminAction(`/api/admin/ban_group/${groupId}`, 'POST', {
                        reason: 'Admin decided to ban.', // Simplistic reason for quick action
                        duration: 'permanent'
                    }, 'Group banned successfully!');
                }
            }

            // Unban Group
            if (event.target.classList.contains('unban-group-btn')) {
                const groupId = event.target.dataset.groupId;
                const groupName = event.target.closest('tr').dataset.groupname;
                if (confirm(`Are you sure you want to unban group "${groupName}"?`)) {
                    sendAdminAction(`/api/admin/unban_group/${groupId}`, 'POST', {}, 'Group unbanned successfully!');
                }
            }

            // Delete Group
            if (event.target.classList.contains('delete-group-btn')) {
                const groupId = event.target.dataset.groupId;
                const groupName = event.target.closest('tr').dataset.groupname;
                deleteItemNamePlaceholder.textContent = `"${groupName}"`;
                deleteItemTypePlaceholder.textContent = 'Group';
                deleteItemIdInput.value = groupId;
                deleteItemTypeInput.value = 'group';
                deleteConfirmationModal.show();
            }

            // View Report Reason
            if (event.target.classList.contains('view-report-reason-btn')) {
                const reason = event.target.dataset.reason;
                fullReportReasonContent.textContent = reason;
                viewReportReasonModal.show();
            }

            // Handle Report - Warn
            if (event.target.classList.contains('handle-report-warn-btn')) {
                const reportId = event.target.dataset.reportId;
                const itemId = event.target.dataset.itemId;
                const itemType = event.target.dataset.itemType;
                // Pre-fill warn modal based on report details
                warnUserModal.show(); // Assuming it's a user or similar warn
                // Logic to set warnUserIdInput, warningTitleInput, warningDescriptionInput
                // based on itemId and itemType from the report
            }

            // Handle Report - Ban
            if (event.target.classList.contains('handle-report-ban-btn')) {
                const reportId = event.target.dataset.reportId;
                const itemId = event.target.dataset.itemId;
                const itemType = event.target.dataset.itemType;
                banUserModal.show(); // Assuming it's a user or similar ban
                // Logic to set banUserIdInput, banReasonInput etc.
            }

            // Handle Report - Ignore
            if (event.target.classList.contains('handle-report-ignore-btn')) {
                const reportId = event.target.dataset.reportId;
                if (confirm('Are you sure you want to mark this report as handled/ignored?')) {
                    sendAdminAction(`/api/admin/handle_report/${reportId}/ignore`, 'POST', {}, 'Report ignored.');
                }
            }
        });


        // --- Confirm Actions from Modals ---
        confirmWarnUserBtn.addEventListener('click', function() {
            const userId = warnUserIdInput.value;
            const title = warningTitleInput.value.trim();
            const description = warningDescriptionInput.value.trim();
            if (!title || !description) {
                alert('Please provide both title and description for the warning.');
                return;
            }
            sendAdminAction(`/api/admin/warn_user/${userId}`, 'POST', { title, description }, 'Warning issued successfully!');
            warnUserModal.hide();
        });

        confirmBanUserBtn.addEventListener('click', function() {
            const userId = banUserIdInput.value;
            const reason = banReasonInput.value.trim();
            const duration = banDurationSelect.value;
            const days = duration === 'temporary' ? parseInt(banDaysInput.value) : null;

            if (!reason) {
                alert('Please provide a reason for the ban.');
                return;
            }
            if (duration === 'temporary' && (isNaN(days) || days < 1)) {
                alert('Please provide a valid number of days for a temporary ban.');
                return;
            }

            sendAdminAction(`/api/admin/ban_user/${userId}`, 'POST', { reason, duration, days }, 'User banned successfully!');
            banUserModal.hide();
        });

        confirmDeleteBtn.addEventListener('click', function() {
            const itemId = deleteItemIdInput.value;
            const itemType = deleteItemTypeInput.value; // 'user', 'group', 'post', 'reel', 'story'
            sendAdminAction(`/api/admin/delete_${itemType}/${itemId}`, 'POST', {}, `${itemType} deleted permanently!`);
            deleteConfirmationModal.hide();
        });


        // --- Generic AJAX Function for Admin Actions ---
        function sendAdminAction(url, method, body, successMessage) {
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: body ? JSON.stringify(body) : null
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(successMessage); // Replace with custom modal
                    location.reload(); // Reload page to reflect changes
                } else {
                    alert('Action failed: ' + data.message); // Replace with custom modal
                }
            })
            .catch(error => {
                console.error('Admin action error:', error);
                alert('An error occurred during the action.'); // Replace with custom modal
            });
        }

        // --- Broadcast Message Form ---
        const broadcastMessageForm = document.getElementById('broadcastMessageForm');
        const broadcastMessageContent = document.getElementById('broadcastMessageContent');

        broadcastMessageForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const message = broadcastMessageContent.value.trim();
            if (!message) {
                alert('Please type a message to broadcast.');
                return;
            }

            if (confirm('Are you sure you want to send this message to ALL users as a system notification?')) {
                sendAdminAction('/api/admin/broadcast_message', 'POST', { message: message }, 'Broadcast message sent!');
                broadcastMessageContent.value = ''; // Clear input
            }
        });

        // --- Admin Story Post Form ---
        const adminStoryForm = document.getElementById('adminStoryForm');
        const adminStoryMedia = document.getElementById('adminStoryMedia');
        const adminStoryImagePreview = document.getElementById('adminStoryImagePreview');
        const adminStoryVideoPreview = document.getElementById('adminStoryVideoPreview');
        const noAdminStoryMediaText = document.getElementById('noAdminStoryMediaText');
        const adminStoryDescription = document.getElementById('adminStoryDescription');

        // Media preview for admin story
        adminStoryMedia.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    noAdminStoryMediaText.style.display = 'none';
                    if (file.type.startsWith('image/')) {
                        adminStoryImagePreview.src = e.target.result;
                        adminStoryImagePreview.style.display = 'block';
                        adminStoryVideoPreview.style.display = 'none';
                        adminStoryVideoPreview.src = '';
                    } else if (file.type.startsWith('video/')) {
                         const tempVideo = document.createElement('video');
                            tempVideo.preload = 'metadata';
                            tempVideo.onloadedmetadata = function() {
                                window.URL.revokeObjectURL(tempVideo.src);
                                if (tempVideo.duration > 30) { // Max 30 seconds for story
                                    alert(`Video is too long (${Math.round(tempVideo.duration)}s). Max 30 seconds allowed.`);
                                    adminStoryMedia.value = ''; // Clear input
                                    noAdminStoryMediaText.style.display = 'block';
                                    adminStoryImagePreview.style.display = 'none';
                                    adminStoryVideoPreview.style.display = 'none';
                                    adminStoryImagePreview.src = '';
                                    adminStoryVideoPreview.src = '';
                                    return;
                                }
                                adminStoryVideoPreview.src = e.target.result;
                                adminStoryVideoPreview.style.display = 'block';
                                adminStoryImagePreview.style.display = 'none';
                                adminStoryImagePreview.src = '';
                                adminStoryVideoPreview.play();
                            };
                            tempVideo.src = URL.createObjectURL(file);
                    }
                };
                reader.readAsDataURL(file);
            } else {
                noAdminStoryMediaText.style.display = 'block';
                adminStoryImagePreview.style.display = 'none';
                adminStoryVideoPreview.style.display = 'none';
                adminStoryImagePreview.src = '';
                adminStoryVideoPreview.src = '';
            }
        });

        // Admin Story submission
        adminStoryForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const mediaFile = adminStoryMedia.files[0];
            const description = adminStoryDescription.value.trim();

            if (!mediaFile) {
                alert('Please select a photo or video for the story.');
                return;
            }

            const formData = new FormData();
            formData.append('mediaFile', mediaFile);
            if (description) {
                formData.append('description', description);
            }

            fetch('/api/admin/post_sociafam_story', {
                method: 'POST',
                body: formData // No 'Content-Type' header needed for FormData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('SociaFam Story posted successfully!');
                    adminStoryMedia.value = ''; // Clear file input
                    adminStoryDescription.value = ''; // Clear description
                    // Reset preview
                    noAdminStoryMediaText.style.display = 'block';
                    adminStoryImagePreview.style.display = 'none';
                    adminStoryVideoPreview.style.display = 'none';
                    adminStoryImagePreview.src = '';
                    adminStoryVideoPreview.src = '';
                } else {
                    alert('Failed to post story: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error posting admin story:', error);
                alert('An error occurred while posting the story.');
            });
        });
    });
</script>
{% endblock %}
