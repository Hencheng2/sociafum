{% extends 'base.html' %}

{% block title %}Create New Story{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Create New Story</h2>
    <form id="storyForm" enctype="multipart/form-data" method="POST" action="{{ url_for('create_story') }}">
        {# Media Upload Section #}
        <div class="mb-3">
            <label class="form-label">Upload a photo or video, or record a voice note</label>
            <div class="input-group mb-2">
                <input type="file" class="form-control" id="mediaFile" name="mediaFile" accept="image/*,video/*" onchange="updateMediaPreview()">
                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('mediaFile').click()">Select Photo/Video</button>
            </div>
            <div class="input-group mb-2">
                <button type="button" class="btn btn-outline-primary" id="recordVoiceBtn" onclick="startVoiceRecording()">Record Voice Note</button>
                <button type="button" class="btn btn-outline-danger d-none" id="stopVoiceBtn" onclick="stopVoiceRecording()">Stop Recording</button>
            </div>
            <div class="input-group mb-2">
                <button type="button" class="btn btn-outline-primary" id="openCameraBtn" onclick="openCamera()">Open Camera</button>
            </div>
        </div>

        {# Media Preview #}
        <div class="mb-3" id="mediaPreview" style="display: none;">
            <img id="imagePreview" class="img-fluid mb-2" style="max-height: 200px; display: none;">
            <video id="videoPreview" class="img-fluid mb-2" controls style="max-height: 200px; display: none;"></video>
            <audio id="audioPreview" class="w-100 mb-2" controls style="display: none;"></audio>
        </div>

        {# Voice Note Recording Section #}
        <div class="mb-3" id="voiceNoteSection">
            <label class="form-label">Voice Note</label>
            <div class="d-flex align-items-center">
                <span id="voiceTimer">00:00</span>
                <input type="hidden" id="voiceNoteData" name="voiceNoteData">
            </div>
            <small class="form-text text-muted">Max 30 seconds.</small>
        </div>

        {# Audio Upload Section (conditionally shown for photos) #}
        <div class="mb-3" id="backgroundAudioSection" style="display: none;">
            <label class="form-label">Add Background Audio (Optional, for photos only)</label>
            <input type="file" class="form-control" id="backgroundAudio" name="backgroundAudio" accept="audio/*">
            <small class="form-text text-muted">Upload an audio file to accompany your photo story.</small>
        </div>

        {# Camera Live Feed Section #}
        <div class="mb-3" id="cameraSection" style="display: none;">
            <label class="form-label">Live Camera Feed</label>
            <video id="cameraFeed" class="img-fluid mb-2" autoplay style="max-height: 200px;"></video>
            <div class="btn-group mb-2">
                <button type="button" class="btn btn-primary" id="takePhotoBtn" onclick="takePhoto()">Take Photo</button>
                <button type="button" class="btn btn-primary" id="recordVideoBtn" onclick="startVideoRecording()">Record Video</button>
                <button type="button" class="btn btn-danger d-none" id="stopVideoBtn" onclick="stopVideoRecording()">Stop Recording</button>
            </div>
            <small class="form-text text-muted">Videos max 30 seconds.</small>
            <input type="hidden" id="cameraData" name="cameraData">
            <input type="hidden" id="cameraType" name="cameraType">
        </div>

        {# Story Description #}
        <div class="mb-3">
            <label for="description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="description" name="description" rows="4" placeholder="You can tag other users using @username."></textarea>
        </div>

        {# Visibility - Fixed to Friends Only #}
        <div class="mb-3">
            <label class="form-label">Who can see this story?</label>
            <p>Friends Only</p>
            <input type="hidden" name="visibility" value="friends">
        </div>

        {# Form Buttons #}
        <div class="mb-3">
            <button type="submit" class="btn btn-primary">Create Story</button>
            <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
let mediaRecorder;
let recordedChunks = [];
let voiceRecording = false;
let videoRecording = false;
let stream;

// Initialize media preview
function updateMediaPreview() {
    const fileInput = document.getElementById('mediaFile');
    const imagePreview = document.getElementById('imagePreview');
    const videoPreview = document.getElementById('videoPreview');
    const audioPreview = document.getElementById('audioPreview');
    const mediaPreview = document.getElementById('mediaPreview');
    const backgroundAudioSection = document.getElementById('backgroundAudioSection');

    imagePreview.style.display = 'none';
    videoPreview.style.display = 'none';
    audioPreview.style.display = 'none';
    mediaPreview.style.display = 'none';

    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileType = file.type.split('/')[0];

        if (fileType === 'image') {
            imagePreview.src = URL.createObjectURL(file);
            imagePreview.style.display = 'block';
            backgroundAudioSection.style.display = 'block';
            mediaPreview.style.display = 'block';
        } else if (fileType === 'video') {
            videoPreview.src = URL.createObjectURL(file);
            videoPreview.style.display = 'block';
            backgroundAudioSection.style.display = 'none';
            mediaPreview.style.display = 'block';
        }
    }
}

// Voice recording functionality
function startVoiceRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(s => {
            stream = s;
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => {
                recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                document.getElementById('audioPreview').src = URL.createObjectURL(blob);
                document.getElementById('audioPreview').style.display = 'block';
                document.getElementById('mediaPreview').style.display = 'block';
                document.getElementById('voiceNoteData').value = URL.createObjectURL(blob);
                recordedChunks = [];
            };
            mediaRecorder.start();
            voiceRecording = true;
            document.getElementById('recordVoiceBtn').classList.add('d-none');
            document.getElementById('stopVoiceBtn').classList.remove('d-none');
            updateTimer();
        })
        .catch(err => {
            alert('Error accessing microphone: ' + err.message);
        });
}

function stopVoiceRecording() {
    if (mediaRecorder && voiceRecording) {
        mediaRecorder.stop();
        stream.getTracks().forEach(track => track.stop());
        voiceRecording = false;
        document.getElementById('recordVoiceBtn').classList.remove('d-none');
        document.getElementById('stopVoiceBtn').classList.add('d-none');
        clearInterval(timerInterval);
        document.getElementById('voiceTimer').textContent = '00:00';
    }
}

let timerInterval;
function updateTimer() {
    let seconds = 0;
    timerInterval = setInterval(() => {
        seconds++;
        if (seconds >= 30) {
            stopVoiceRecording();
        }
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('voiceTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
}

// Camera functionality
function openCamera() {
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(s => {
            stream = s;
            document.getElementById('cameraFeed').srcObject = stream;
            document.getElementById('cameraSection').style.display = 'block';
        })
        .catch(err => {
            alert('Error accessing camera: ' + err.message);
        });
}

function takePhoto() {
    const canvas = document.createElement('canvas');
    const video = document.getElementById('cameraFeed');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL('image/jpeg');
    document.getElementById('imagePreview').src = dataUrl;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('mediaPreview').style.display = 'block';
    document.getElementById('cameraData').value = dataUrl;
    document.getElementById('cameraType').value = 'image';
    document.getElementById('backgroundAudioSection').style.display = 'block';
    stream.getTracks().forEach(track => track.stop());
    document.getElementById('cameraSection').style.display = 'none';
}

function startVideoRecording() {
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => {
        recordedChunks.push(e.data);
    };
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        document.getElementById('videoPreview').src = URL.createObjectURL(blob);
        document.getElementById('videoPreview').style.display = 'block';
        document.getElementById('mediaPreview').style.display = 'block';
        document.getElementById('cameraData').value = URL.createObjectURL(blob);
        document.getElementById('cameraType').value = 'video';
        recordedChunks = [];
    };
    mediaRecorder.start();
    videoRecording = true;
    document.getElementById('recordVideoBtn').classList.add('d-none');
    document.getElementById('stopVideoBtn').classList.remove('d-none');
    updateTimer();
}

function stopVideoRecording() {
    if (mediaRecorder && videoRecording) {
        mediaRecorder.stop();
        stream.getTracks().forEach(track => track.stop());
        videoRecording = false;
        document.getElementById('recordVideoBtn').classList.remove('d-none');
        document.getElementById('stopVideoBtn').classList.add('d-none');
        document.getElementById('cameraSection').style.display = 'none';
        clearInterval(timerInterval);
        document.getElementById('voiceTimer').textContent = '00:00';
    }
}

// Form submission validation
document.getElementById('storyForm').addEventListener('submit', function(e) {
    const mediaFile = document.getElementById('mediaFile').files.length > 0;
    const voiceNote = document.getElementById('voiceNoteData').value;
    const cameraData = document.getElementById('cameraData').value;

    if (!mediaFile && !voiceNote && !cameraData) {
        e.preventDefault();
        alert('Please select a photo, video, or voice note for your story.');
    }
});
</script>
{% endblock %}
