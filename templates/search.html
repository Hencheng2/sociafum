{% extends 'base.html' %}

{% block title %}Search{% endblock %}

{% block content %}
<style>
    .search-container {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
    }
    .search-bar {
        margin-bottom: 20px;
    }
    .search-bar form {
        display: flex;
        align-items: center;
    }
    .search-bar input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        font-size: 16px;
    }
    .search-bar button {
        margin-left: 10px;
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
    }
    .tab-container {
        display: flex;
        flex-wrap: wrap;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 20px;
    }
    .tab {
        flex: 1;
        padding: 10px 20px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        color: #6c757d;
        transition: all 0.3s;
    }
    .tab.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .result-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .result-item img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .result-info {
        flex: 1;
    }
    .result-info h3 {
        margin: 0;
        font-size: 16px;
    }
    .result-info p {
        margin: 0;
        font-size: 12px;
        color: #6c757d;
    }
    .result-actions {
        display: flex;
        gap: 10px;
    }
    .result-actions button {
        padding: 5px 10px;
        border: none;
        background: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
    }
    .result-actions button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    .post-item, .reel-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .post-item img, .reel-item img {
        max-width: 200px;
        border-radius: 5px;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        max-width: 500px;
        width: 90%;
    }
    .modal-content img, .modal-content video {
        max-width: 100%;
        border-radius: 5px;
    }
    @media (max-width: 600px) {
        .tab-container {
            flex-direction: column;
        }
        .tab {
            flex: none;
            padding: 10px;
        }
        .search-bar form {
            flex-direction: column;
        }
        .search-bar button {
            margin-left: 0;
            margin-top: 10px;
            width: 100%;
        }
    }
</style>

<div class="search-container">
    <div class="search-bar">
        <form action="{{ url_for('search') }}" method="get">
            <input type="text" name="q" placeholder="Search SociaFam" value="{{ query | default('') }}" oninput="searchLive()">
            <button type="submit">Search</button>
        </form>
    </div>

    <div class="tab-container">
        <div class="tab active" onclick="showTab('all')">All</div>
        <div class="tab" onclick="showTab('users')">Users</div>
        <div class="tab" onclick="showTab('groups')">Groups</div>
        <div class="tab" onclick="showTab('posts')">Posts</div>
        <div class="tab" onclick="showTab('reels')">Reels</div>
    </div>

    <div id="all" class="tab-content active">
        {% if search_results %}
            {% for item in search_results %}
                {% if item.type == 'user' %}
                    <div class="result-item">
                        <img src="{{ item.data.profilePhoto | default('/static/img/default_profile.png') }}" alt="Profile">
                        <div class="result-info">
                            <h3>{{ item.data.real_name }}</h3>
                            <p>@{{ item.data.username }} | User</p>
                        </div>
                        <div class="result-actions">
                            <button onclick="friendRequest({{ item.data.id }})" {% if item.data.is_following %}disabled{% endif %}>
                                {{ 'Following' if item.data.is_following else 'Follow' }}
                            </button>
                            <button onclick="openChat({{ item.data.id }})">Message</button>
                        </div>
                    </div>
                {% elif item.type == 'group' %}
                    <div class="result-item">
                        <img src="{{ item.data.profilePhoto | default('/static/img/default_group.png') }}" alt="Group">
                        <div class="result-info">
                            <h3>{{ item.data.name }}</h3>
                            <p>{{ item.data.member_count | default(0) }} Members | Group</p>
                        </div>
                        <div class="result-actions">
                            <button onclick="joinGroup({{ item.data.id }})" {% if item.data.is_member %}disabled{% endif %}>
                                {{ 'Member' if item.data.is_member else 'Join' }}
                            </button>
                        </div>
                    </div>
                {% elif item.type == 'post' %}
                    <div class="post-item" onclick="openPostModal({{ item.data.id }})">
                        <p>{{ item.data.description | default('No description') }}</p>
                        {% if item.data.media_path %}
                            <img src="{{ item.data.media_path }}" alt="Post Media">
                        {% endif %}
                        <p>Posted by @{{ item.data.username }} | {{ moment(item.data.timestamp).fromNow() }}</p>
                    </div>
                {% elif item.type == 'reel' %}
                    <div class="reel-item" onclick="openReelModal({{ item.data.id }})">
                        {% if item.data.media_path %}
                            <video src="{{ item.data.media_path }}" width="200" muted></video>
                        {% endif %}
                        <p>Posted by @{{ item.data.username }} | {{ moment(item.data.timestamp).fromNow() }}</p>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p>Start typing to search for content across SociaFam.</p>
        {% endif %}
    </div>

    <div id="users" class="tab-content">
        {% if search_results | selectattr('type', 'equalto', 'user') | list %}
            {% for item in search_results | selectattr('type', 'equalto', 'user') %}
                <div class="result-item">
                    <img src="{{ item.data.profilePhoto | default('/static/img/default_profile.png') }}" alt="Profile">
                    <div class="result-info">
                        <h3>{{ item.data.real_name }}</h3>
                        <p>@{{ item.data.username }}</p>
                    </div>
                    <div class="result-actions">
                        <button onclick="friendRequest({{ item.data.id }})" {% if item.data.is_following %}disabled{% endif %}>
                            {{ 'Following' if item.data.is_following else 'Follow' }}
                        </button>
                        <button onclick="openChat({{ item.data.id }})">Message</button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No users found.</p>
        {% endif %}
    </div>

    <div id="groups" class="tab-content">
        {% if search_results | selectattr('type', 'equalto', 'group') | list %}
            {% for item in search_results | selectattr('type', 'equalto', 'group') %}
                <div class="result-item">
                    <img src="{{ item.data.profilePhoto | default('/static/img/default_group.png') }}" alt="Group">
                    <div class="result-info">
                        <h3>{{ item.data.name }}</h3>
                        <p>{{ item.data.member_count | default(0) }} Members</p>
                    </div>
                    <div class="result-actions">
                        <button onclick="joinGroup({{ item.data.id }})" {% if item.data.is_member %}disabled{% endif %}>
                            {{ 'Member' if item.data.is_member else 'Join' }}
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No groups found.</p>
        {% endif %}
    </div>

    <div id="posts" class="tab-content">
        {% if search_results | selectattr('type', 'equalto', 'post') | list %}
            {% for item in search_results | selectattr('type', 'equalto', 'post') %}
                <div class="post-item" onclick="openPostModal({{ item.data.id }})">
                    <p>{{ item.data.description | default('No description') }}</p>
                    {% if item.data.media_path %}
                        <img src="{{ item.data.media_path }}" alt="Post Media">
                    {% endif %}
                    <p>Posted by @{{ item.data.username }} | {{ moment(item.data.timestamp).fromNow() }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p>No posts found with that keyword.</p>
        {% endif %}
    </div>

    <div id="reels" class="tab-content">
        {% if search_results | selectattr('type', 'equalto', 'reel') | list %}
            {% for item in search_results | selectattr('type', 'equalto', 'reel') %}
                <div class="reel-item" onclick="openReelModal({{ item.data.id }})">
                    {% if item.data.media_path %}
                        <video src="{{ item.data.media_path }}" width="200" muted></video>
                    {% endif %}
                    <p>Posted by @{{ item.data.username }} | {{ moment(item.data.timestamp).fromNow() }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p>No reels found with that keyword.</p>
        {% endif %}
    </div>
</div>

<!-- Post Detail Modal -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <h2>Post Details</h2>
        <div id="postModalContent">
            <p>Loading post...</p>
        </div>
        <button onclick="closeModal('postModal')">Close</button>
    </div>
</div>

<!-- Reel Viewer Modal -->
<div id="reelModal" class="modal">
    <div class="modal-content">
        <div id="reelModalContent">
            <p>Loading reel...</p>
        </div>
        <button onclick="closeModal('reelModal')">Close</button>
    </div>
</div>

<script>
    function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    let debounceTimer;
    function searchLive() {
        clearTimeout(debounceTimer);
        const query = document.querySelector('input[name="q"]').value.trim();
        if (!query) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.innerHTML = '<p>Start typing to search for content across SociaFam.</p>';
            });
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch(`/api/search_users?term=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    updateTabContent('users', data.results.filter(item => item.type === 'user'));
                    updateTabContent('all', data.results);
                    // Fetch groups, posts, reels via additional APIs
                    fetch(`/api/search_groups?term=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => updateTabContent('groups', data.results))
                        .catch(() => document.getElementById('groups').innerHTML = '<p>Error searching groups.</p>');
                    fetch(`/api/search_posts?term=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => updateTabContent('posts', data.results))
                        .catch(() => document.getElementById('posts').innerHTML = '<p>Error searching posts.</p>');
                    fetch(`/api/search_reels?term=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => updateTabContent('reels', data.results))
                        .catch(() => document.getElementById('reels').innerHTML = '<p>Error searching reels.</p>');
                })
                .catch(error => {
                    console.error('Error searching:', error);
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.innerHTML = '<p>Error searching. Please try again.</p>';
                    });
                });
        }, 300);
    }

    function updateTabContent(tabId, results) {
        const container = document.getElementById(tabId);
        container.innerHTML = '';
        if (results.length === 0) {
            container.innerHTML = `<p>No ${tabId} found.</p>`;
            return;
        }
        results.forEach(item => {
            if (item.type === 'user') {
                const user = item.data;
                const html = `
                    <div class="result-item">
                        <img src="${user.profilePhoto || '/static/img/default_profile.png'}" alt="Profile">
                        <div class="result-info">
                            <h3>${user.real_name}</h3>
                            <p>@${user.username}</p>
                        </div>
                        <div class="result-actions">
                            <button onclick="friendRequest(${user.id})" ${user.is_following ? 'disabled' : ''}>
                                ${user.is_following ? 'Following' : 'Follow'}
                            </button>
                            <button onclick="openChat(${user.id})">Message</button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            } else if (item.type === 'group') {
                const group = item.data;
                const html = `
                    <div class="result-item">
                        <img src="${group.profilePhoto || '/static/img/default_group.png'}" alt="Group">
                        <div class="result-info">
                            <h3>${group.name}</h3>
                            <p>${group.member_count || 0} Members</p>
                        </div>
                        <div class="result-actions">
                            <button onclick="joinGroup(${group.id})" ${group.is_member ? 'disabled' : ''}>
                                ${group.is_member ? 'Member' : 'Join'}
                            </button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            } else if (item.type === 'post') {
                const post = item.data;
                const html = `
                    <div class="post-item" onclick="openPostModal(${post.id})">
                        <p>${post.description || 'No description'}</p>
                        ${post.media_path ? `<img src="${post.media_path}" alt="Post Media">` : ''}
                        <p>Posted by @${post.username} | ${new Date(post.timestamp).toLocaleString()}</p>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            } else if (item.type === 'reel') {
                const reel = item.data;
                const html = `
                    <div class="reel-item" onclick="openReelModal(${reel.id})">
                        ${reel.media_path ? `<video src="${reel.media_path}" width="200" muted></video>` : ''}
                        <p>Posted by @${reel.username} | ${new Date(reel.timestamp).toLocaleString()}</p>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            }
        });
    }

    function friendRequest(userId) {
        fetch('/api/friend_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to send friend request.');
            }
        });
    }

    function joinGroup(groupId) {
        fetch('/api/join_group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ group_id: groupId })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to join group.');
            }
        });
    }

    function openChat(userId) {
        fetch(`/api/chat/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/chat/${userId}`;
                } else {
                    alert('Failed to open chat.');
                }
            });
    }

    function openPostModal(postId) {
        fetch(`/api/posts/${postId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = document.getElementById('postModal');
                    const content = document.getElementById('postModalContent');
                    content.innerHTML = `
                        <p>${data.post.description || 'No description'}</p>
                        ${data.post.media_path ? `<img src="${data.post.media_path}" alt="Post Media">` : ''}
                        <p>Posted by @${data.post.username} | ${new Date(data.post.timestamp).toLocaleString()}</p>
                    `;
                    modal.style.display = 'flex';
                } else {
                    alert('Failed to load post.');
                }
            });
    }

    function openReelModal(reelId) {
        fetch(`/api/reels/${reelId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = document.getElementById('reelModal');
                    const content = document.getElementById('reelModalContent');
                    content.innerHTML = `
                        ${data.reel.media_path ? `<video src="${data.reel.media_path}" controls autoplay></video>` : ''}
                        <p>Posted by @${data.reel.username} | ${new Date(data.reel.timestamp).toLocaleString()}</p>
                    `;
                    modal.style.display = 'flex';
                } else {
                    alert('Failed to load reel.');
                }
            });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
</script>
{% endblock %}
